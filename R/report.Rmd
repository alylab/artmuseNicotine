---
title: "Figures and main text results"
author: "Monica Thieu"
date: "3/27/2020"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(magrittr)
library(rlang)
source(here::here("R", "paths.R"))

load(paste(stats_dir, "raw.rda", sep = "/"))
load(paste(stats_dir,"preplots_rstanarm.rda", sep = "/"))
load(paste(stats_dir,"preplots_rt_rstanarm.rda", sep = "/"))
load(paste(stats_dir, "aprime_by_ppm.rda", sep = "/"))
load(paste(stats_dir, "pca.rda", sep = "/"))
load(paste(stats_dir, "models_anova.rda", sep = "/"))

figures_dir <- here::here("ignore", "figures")

this_theme <- function (...) {
  
  out <- theme_bw() +
    theme(plot.title.position = "plot",
          axis.title = element_text(size = rel(1.2)),
          axis.text = element_text(size = rel(1)),
          strip.text = element_text(size = rel(1))) +
    theme(...)
  
  return (out)
}

signif_digits <- 3L
colors_exptCond <- c("#eb000c", "#24aaf2")
colors_exptCond_probe <- c(colors_exptCond, "#ff5c74",  "#80ccff")
```

# The figures

## Figure 4

```{r minor-plot-2x2x2-coefs}
plot_minor_coefs <- function (model_name, boot = F, ...) {
  dots <- list2(...)
  
  if (boot) {
    interval_type = "bootstrapped confidence"
    coefs <- aprime_by_ppm_boot %>%
      mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
      filter(metric_type == "aprime",
             startsWith(model_type, model_name)) %>%
      select(iteration, model_type, exptCond, probe, starts_with("coefs")) %>%
      mutate(coefs_raw = map(coefs_raw, ~rename_if(.x, is.numeric, ~paste0(., "_raw")))) %>% 
      mutate(coefs = map2(coefs_boot, coefs_raw, ~full_join(.x, .y, by = "term"))) %>% 
      select(-coefs_boot, -coefs_raw) %>% 
      unnest(coefs) %>%
      mutate(term = recode_factor(term,
                                  !!!dots)) %>%
      group_by(exptCond, probe, term) %>%
      summarize(est_median = median(estimate_raw),
                est_q025 = quantile(estimate, .025),
                est_q25 = quantile(estimate, .25),
                est_q75 = quantile(estimate, .75),
                est_q975 = quantile(estimate, .975))
  } else {
    interval_type = "credible"
    coefs <- preplots_params %>%
    filter(startsWith(name, model_name)) %>%
    unnest(iterations) %>%
    mutate(term = recode_factor(term,
                                !!!dots)) %>%
    group_by(term) %>%
    summarize(est_median = median(estimate),
              est_q025 = quantile(estimate, .025),
              est_q25 = quantile(estimate, .25),
              est_q75 = quantile(estimate, .75),
              est_q975 = quantile(estimate, .975))
  }
  
  if (boot) {
    out <- coefs %>%
    ggplot(aes(x = est_median, y = factor(1), color = interaction(exptCond, probe)))
  } else {
        out <- coefs %>%
    ggplot(aes(x = est_median, y = fct_rev(term)))
  }
  
  out <- out +
    geom_vline(xintercept = 0, linetype = 3) +
    geom_errorbarh(aes(xmin = est_q025, xmax = est_q975), height = 0) +
    # geom_errorbarh(aes(xmin = est_q25, xmax = est_q75), size = 1, height = 0) +
    geom_point() +
    labs(x = glue::glue("coefficient +- {interval_type} interval"), y = NULL) +
    this_theme(plot.title.position = "panel")
  
  if (boot) {
    out <- out + facet_grid(exptCond + probe ~ term, scales = "free_x") +
      scale_color_manual(values = colors_exptCond_probe) +
      guides(color = FALSE) +
      theme(axis.text.x = element_text(hjust = 1, angle = 45))
  }
  
  return (out)
}

x <- plot_minor_coefs(model_name = "full",
                      intercept = "intercept",
                      corResp = "match status",
                      exptCond = "condition",
                      probe = "attentional state",
                      on_smoking = "smoking status",
                      `corResp:exptCond` = "match status x condition",
                      `corResp:probe` = "match status x attention",
                      `corResp:on_smoking` = "match status x smoking",
                      `probe:exptCond` = " condition x attention",
                      `on_smoking:exptCond` = "condition x smoking",
                      `probe:on_smoking` = "attention x smoking",
                      `corResp:probe:exptCond` = "match status x condition x attention",
                      `corResp:on_smoking:exptCond` = "match status x condition x smoking",
                      `corResp:probe:on_smoking` = "match status x attention x smoking",
                      `probe:on_smoking:exptCond` = "condition x attention x smoking")

x

x %>%
  ggsave(paste(figures_dir, "minor_plot_2x2x2_coefs.png", sep = "/"),
         plot = .,
         device = "png",
         width = 7,
         height = 4.5,
         units = "in")
```

## Figure 5

```{r major-plot-nick}
plot_major_nick <- function (model_name = "full") {
  this_preplot_fixef <- preplots_fixef %>%
    filter(startsWith(name, model_name)) %>%
    mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
    group_by(on_smoking, exptCond, probe) %>%
    summarize(aprime_q025 = quantile(aprime, .025),
              aprime_q975 = quantile(aprime, .975),
              aprime = mean(aprime)
              )
  
  out <- preplots_raw_bysubj %>%
    filter(name == "raw") %>%
    mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
    ggplot(aes(x = on_smoking, y = aprime, color = interaction(exptCond, probe), fill = interaction(exptCond, probe))) +
    geom_line(aes(group = subj_num), alpha = 0.1) +
    geom_jitter(width = 0.1, alpha = 0.2) +
    geom_ribbon(aes(ymin = aprime_q025, ymax = aprime_q975, group = 1),
                data = this_preplot_fixef,
                linetype = 0,
                alpha = 0.4) +
    geom_line(aes(group = 1),
              data = this_preplot_fixef,
              size = 1,
              alpha = 1) +
    geom_hline(yintercept = 0.5, linetype = 3) +
    scale_x_discrete(labels = c("off" = "OFF", "on" = "ON")) +
    scale_color_manual(values = colors_exptCond_probe) +
    scale_fill_manual(values = colors_exptCond_probe) +
    labs(x = "smoking session",
         y = "A'") +
    guides(color = FALSE, fill = FALSE) +
    facet_grid( ~ exptCond + probe) +
    this_theme()
  
  return (out)
}

x <- plot_major_nick("full")
x

x %>%
  ggsave(filename = paste(figures_dir, "major_plot_nick.png", sep = "/"),
       plot = .,
       device = "png",
       width = 7,
       height = 4,
       units = "in")

(x + theme(panel.grid = element_blank())) %>%
  ggsave(filename = paste(figures_dir, "major_plot_nick_grid_none.png", sep = "/"),
       plot = .,
       device = "png",
       width = 7,
       height = 4,
       units = "in")

(x + theme(panel.grid.minor = element_blank())) %>%
  ggsave(filename = paste(figures_dir, "major_plot_nick_grid_minimal.png", sep = "/"),
       plot = .,
       device = "png",
       width = 7,
       height = 4,
       units = "in")
```

## Figure 6

```{r major-plot-aprime-ppm-boot}
x <- aprime_by_ppm_boot %>%
  filter(metric_type == "aprime") %>% 
  select(iteration, exptCond, probe, data_raw) %>%
  unnest(data_raw) %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  group_by(exptCond, probe, obs, ppm_diff, value_diff, value_diff_fit) %>%
  summarize(boot_median = median(predicted),
            boot_q025 = quantile(predicted, .025),
            boot_q975 = quantile(predicted, .975)) %>%
  mutate(rel_room = if_else(exptCond == "similar" & probe == "room", TRUE, FALSE)) %>%
  ggplot(aes(x = ppm_diff, y = value_diff,
             color = interaction(exptCond, probe),
             fill = interaction(exptCond, probe))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", formula = y ~ x, size = 1, alpha = 0.3) +
  geom_text(aes(label = this_label),
            data = crossing(ppm_diff = 7.5, value_diff = -.18,
                            exptCond = c("identical", "similar"), probe = c("art", "room")) %>%
              mutate(this_label = if_else(exptCond == "similar" & probe == "room", "*", "")),
            size = 10, color = "black") +
  scale_color_manual(values = colors_exptCond_probe) +
  scale_fill_manual(values = colors_exptCond_probe) +
  facet_grid(probe ~ exptCond) +
  guides(color = FALSE, fill = FALSE) +
  labs(x = "CO ppm difference (ON smoking - OFF smoking)",
       y = "A' difference (ON smoking - OFF smoking)") +
  this_theme()

x

x %>%
  ggsave(filename = paste(figures_dir, "major_plot_aprime_by_ppm_grid_all.png", sep = "/"),
       plot = .,
       device = "png",
       width = 6,
       height = 6,
       units = "in")

(x + theme(panel.grid = element_blank())) %>%
  ggsave(filename = paste(figures_dir, "major_plot_aprime_by_ppm_grid_none.png", sep = "/"),
       plot = .,
       device = "png",
       width = 6,
       height = 6,
       units = "in")

(x + theme(panel.grid.minor = element_blank())) %>%
  ggsave(filename = paste(figures_dir, "major_plot_aprime_by_ppm_grid_minimal.png", sep = "/"),
       plot = .,
       device = "png",
       width = 6,
       height = 6,
       units = "in")
```

## Figures not included in the main text

### Related to Figure 5

```{r minor-plot-nick-truncated}
preplots_fixef %>%
  filter(name == "full") %>%
  nest(data = -iteration) %>%
  sample_n(300) %>%
  unnest(data) %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  ggplot(aes(x = on_smoking, y = aprime, color = interaction(exptCond, probe))) +
  geom_line(aes(group = interaction(iteration, probe)), alpha = 0.05) +
  geom_line(aes(group = probe),
            data = preplots_fixef %>%
              filter(name == "full") %>%
              mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
              group_by(on_smoking, exptCond, probe) %>%
              summarize(aprime = mean(aprime)),
            size = 1.5,
            alpha = 0.8) +
  scale_color_manual(values = colors_exptCond_probe) +
  labs(x = "Smoking session",
       y = "A'",
       title = "Figure Nb",
       subtitle = "putative cholinergic modulation of A'") +
  facet_grid( ~ exptCond) +
  this_theme()
```

```{r minor-plot-nick-truncated-ribbon}
x <- preplots_fixef %>%
  filter(name == "full") %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  group_by(on_smoking, exptCond, probe) %>%
              summarize(aprime_mean = mean(aprime),
                        aprime_q025 = quantile(aprime, .025),
                        aprime_q975 = quantile(aprime, .975)) %>%
  ggplot(aes(x = on_smoking, y = aprime_mean,
             color = interaction(exptCond, probe, sep = " "),
             fill = interaction(exptCond, probe, sep = " "))) +
  geom_ribbon(aes(ymin = aprime_q025, ymax = aprime_q975, group = probe),
              linetype = 0,
              alpha = 0.25) +
  geom_line(aes(group = probe),
            size = 1.5,
            alpha = 0.8) +
  scale_color_manual(values = colors_exptCond_probe) +
  scale_fill_manual(values = colors_exptCond_probe) +
  labs(x = "smoking session",
       y = "A'",
       color = "trial type",
       fill = "trial type") +
  facet_grid( ~ exptCond) +
  this_theme()

x

x %>%
  ggsave(filename = paste(figures_dir, "minor_plot_nick_truncated.png", sep = "/"),
       plot = .,
       device = "png",
       width = 5,
       height = 4,
       units = "in")

(x + theme(panel.grid = element_blank())) %>%
  ggsave(filename = paste(figures_dir, "minor_plot_nick_truncated_grid_none.png", sep = "/"),
       plot = .,
       device = "png",
       width = 5,
       height = 4,
       units = "in")

(x + theme(panel.grid.minor = element_blank())) %>%
  ggsave(filename = paste(figures_dir, "minor_plot_nick_truncated_grid_minimal.png", sep = "/"),
       plot = .,
       device = "png",
       width = 5,
       height = 4,
       units = "in")
```

### Related to Figure 6

```{r minor-plot-aprime-ppm-resid-boot}
aprime_by_ppm_boot %>%
  filter(metric_type == "aprime", model_type == "main") %>% 
  select(iteration, exptCond, probe, data_raw) %>%
  unnest(data_raw) %>%
  group_by(exptCond, probe, obs, ppm_diff_resid, value_diff_resid, value_diff_fit_resid) %>%
  summarize(boot_median = median(predicted),
            boot_q025 = quantile(predicted, .025),
            boot_q975 = quantile(predicted, .975)) %>%
  mutate(rel_room = if_else(exptCond == "relational" & probe == "room", TRUE, FALSE)) %>%
  ggplot(aes(x = ppm_diff_resid, y = value_diff_resid, color = rel_room, fill = rel_room)) +
  geom_point(alpha = 0.5) +
  geom_ribbon(aes(ymin = boot_q025, ymax = boot_q975), color = FALSE, alpha = 0.3) +
  geom_line(aes(y = value_diff_fit_resid), size = 1) +
  geom_text(aes(label = glue::glue("beta = {estimate_raw}\n95% boot int = [{boot_q025}, {boot_q975}]")),
            data = aprime_by_ppm_boot %>%
              filter(metric_type == "aprime", model_type == "main") %>% 
              mutate(coefs = map2(coefs_boot, coefs_raw,
                                  ~full_join(.x, .y, by = "term", suffix = c("", "_raw")))) %>%
              select(iteration, exptCond, probe, coefs) %>%
              unnest(coefs) %>%
              group_by(exptCond, probe, term, estimate_raw) %>%
              summarize(boot_median = median(estimate),
                        boot_mean = mean(estimate),
                        boot_q025 = quantile(estimate, .025),
                        boot_q975 = quantile(estimate, .975)) %>%
              mutate_if(is.numeric, signif, digits = signif_digits) %>%
              filter(term == "ppm_diff") %>%
              mutate(rel_room = if_else(exptCond == "relational" & probe == "room", TRUE, FALSE)),
            x = 9, y = -0.5, hjust = 1) +
  # geom_smooth(method = "lm", fill = "blue") +
  facet_grid(probe ~ exptCond) +
  guides(color = FALSE, fill = FALSE) +
  labs(x = "ppm_diff | aprime_off",
       y = "aprime_diff | aprime_off",
       title = "added variable plot of ppm_diff") +
  theme_bw()
```

```{r minor-plot-aprime-ppm-coefplot-boot}
aprime_by_ppm_boot %>%
  filter(metric_type == "aprime", model_type == "main") %>% 
  mutate(coefs = map2(coefs_boot, coefs_raw,
                      ~full_join(.x, .y, by = "term", suffix = c("", "_raw")))) %>%
  select(iteration, exptCond, probe, coefs) %>%
  unnest(coefs) %>%
  mutate(term = recode_factor(term,
                              `(Intercept)` = "Intercept",
                              aprime_off_c = "A' OFF smoking",
                              ppm_diff = "ON - OFF change in CO ppm")) %>%
  group_by(exptCond, probe, term, estimate_raw) %>%
  summarize(boot_median = median(estimate),
            boot_mean = mean(estimate),
            boot_q025 = quantile(estimate, .025),
            boot_q25 = quantile(estimate, .25),
            boot_q75 = quantile(estimate, .75),
            boot_q975 = quantile(estimate, .975)) %>%
  ggplot(aes(x = boot_median, y = "term")) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_errorbarh(aes(xmin = boot_q025, xmax = boot_q975), height = 0) +
  geom_errorbarh(aes(xmin = boot_q25, xmax = boot_q75), height = 0, size = 1) +
  geom_point() +
  geom_point(aes(x = boot_mean), color = "purple") +
  geom_point(aes(x = estimate_raw), color = "hotpink") +
  facet_grid(exptCond + probe ~ term, scales = "free_x") +
  labs(x = "coefficient (unit effect on ON-OFF A' difference)",
       y = "model term",
       title = "model: A' diff ~ A' off (center = 0.5) + ppm diff (raw units)") +
  theme_bw()
```

Note for the above plots: The bootstrapped sampling distributions for the intercept and off-smoking A' terms are not centered on the observed values. What's happening? Basically, the people with shitty off-smoking A' and a huge improvement in A', AND the people with great off-smoking A' and a huge reduction in A', are more likely to get bootstrap-resampled with relatively extreme values (sort of like... reverse regression to the mean), driving the center of the bootstrap distribution of the A' off predictor higher. Additionally, intercepts and A' off slopes are correlated in the bootstrap distribution because the convergence point of the lines is above chance A'.

### Supplemental figures

#### Supplementary Model 1

```{r}
x <- plot_major_nick(model_name = "dummy_all")
x
```

#### Supplementary Model 2

```{r}
x <- plot_major_nick(model_name = "sep")
x
```

#### Supplementary Model 3

```{r}
x <- plot_minor_coefs("diffonly", boot = T,
                      `(Intercept)` = "intercept",
                      ppm_diff = "ON-OFF CO ppm difference")

x
```

```{r}
x <- plot_minor_coefs("covar", boot = T,
                      `(Intercept)` = "intercept",
                      ppm_diff = "ON-OFF CO ppm difference",
                      value_off = "OFF smoking A'",
                      years_smoke = "Years of smoking")

x
```

```{r}
x <- pca_nicotine %>%
  factoextra::fviz_pca_var(repel = TRUE) +
  labs(title = "Principal components analysis of nicotine use variables",
       subtitle = "Variable correlation plot") +
  this_theme()

x

x %>%
  ggsave(filename = paste(figures_dir, "supp_plot_pca.png", sep = "/"),
       plot = .,
       device = "png",
       width = 5,
       height = 5,
       units = "in")
```


# Nice-looking results!

Outside of minor content and formatting edits to the body text that I may have missed, the content below should render all of the statistics reported in the paper.

**NB:** I did not set a random seed while running any analyses. As such, you may not be able to _fully_ reproduce the numerical stats reported in the paper if you re-create all the model objects from scratch. Still, any results you get from newly estimated model objects should be negligibly close to what we got the first time around.

--Monica

## Main body of results text

```{r, echo = FALSE}
summarize_report <- function (data, col, ..., stat_name = "", unit_name = "", digs = signif_digits) {
  if (unit_name != "") unit_name %<>% paste0(" ", .)
  glue_in = if_else(stat_name != "",
                    "{stat_name} = {a}{unit_name}, 95% CI [{b}, {c}]",
                    "{a}{unit_name}, 95% CI [{b}, {c}]")
  
  col_chr = as_name(enexpr(col))
  group_cols = enexprs(...)
  
  data %<>%
    select(iteration, !!!group_cols, starts_with(col_chr)) %>%
    pivot_longer(cols = starts_with(col_chr),
                 names_to = "metric_type",
                 values_to = "value",
                 names_prefix = glue::glue("{col_chr}_"))
  
  if (!is.null(group_cols)) {
    data %<>% group_by(!!!group_cols, metric_type)
  } else {
    data %<>% group_by(metric_type)
  }
  data %<>%
    summarize(avg = mean(value, na.rm = T),
              q025 = quantile(value, .025, na.rm = T),
              q975 = quantile(value, .975, na.rm = T)) %>% 
    mutate_at(c("avg", "q025", "q975"), ~formatC(signif(., digits = digs), digits = digs, format = "fg", flag = "#", mode = "double")) %>%
    mutate(txt_apa = pmap_chr(list(avg, q025, q975),
                              function (a, b, c) {glue::glue(glue_in)}
    )
    ) %>% 
     mutate_at(c("avg", "q025", "q975"), as.numeric)
  
  return (data)
}

coefs <- preplots_params %>%
  unnest(iterations) %>%
  summarize_report(estimate, name, term, stat_name = "beta")

coefs_rt <- preplots_rt_params %>%
  unnest(iterations) %>%
  summarize_report(estimate, name, term, stat_name = "beta")

get_coefs <- function (model_name, model_term, these_coefs = coefs) {
  these_coefs %>%
    filter(name == model_name, term == model_term) %>%
    pull(txt_apa)
}
```

```{r, echo = FALSE}
aprimes_manip_check <- preplots_fixef %>%
  filter(name == "manip_check") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = valid, values_from = aprime, names_prefix = "aprime_") %>% 
  mutate(aprime_diff = aprime_1 - aprime_0) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

aprimes_manip_check_exptCond <- preplots_fixef %>%
  filter(name == "manip_check") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = valid, values_from = aprime, names_prefix = "aprime_") %>% 
  mutate(aprime_diff = aprime_1 - aprime_0) %>%
  summarize_report(aprime_diff, exptCond, stat_name = "estimated A' difference")

rts_manip_check <- preplots_rt_fixef %>%
  filter(name == "manip_check") %>%
  pivot_wider(names_from = valid, values_from = ends_with("rt_pred")) %>% 
  mutate(rt_diff = rt_pred_1 - rt_pred_0) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")
```

_Valid vs. Invalid Trials._ We first examined whether our attentional manipulation was successful by comparing performance on valid vs. invalid trials. If attention is effectively engaged by the cue at the beginning of the trial (i.e., ‘ART’ or ‘ROOM’), then performance should be more accurate and faster when the probe matches the cue (i.e., valid trials) than when it does not (i.e., invalid trials; Posner, 1980). To that end, we used a Bayesian mixed model to examine performance across experimental conditions as a function of trial validity (valid vs. invalid trials). These analyses confirmed that participants were more accurate on valid vs. invalid trials, as indexed by a main effect of validity (`r get_coefs("manip_check", "corResp:valid")`; `r aprimes_manip_check$txt_apa`). We also found an interaction of validity and condition on accuracy, such that participants showed a smaller valid vs. invalid boost in A’ for identical trials relative to similar trials (`r get_coefs("manip_check", "corResp:valid:exptCond")`; identical trials: `r aprimes_manip_check_exptCond %>% filter(exptCond == "control") %>% pull(txt_apa)`; similar trials: `r aprimes_manip_check_exptCond %>% filter(exptCond == "relational") %>% pull(txt_apa)`). Furthermore, an analysis of log-transformed response times (RTs) confirmed that participants were faster on valid vs. invalid trials (`r get_coefs("manip_check", "valid", coefs_rt)`; `r rts_manip_check$txt_apa`).

Taken together, these results suggest that attention was effectively engaged by the cue at the beginning of the trial: Participants were more accurate and faster on valid vs. invalid trials. Having verified that participants modulated their attention based on trial instructions, we next focused analyses on valid trials.

```{r, echo = FALSE}
aprimes_2x2x2_exptCond <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = exptCond, values_from = aprime) %>%
  mutate(aprime_diff = relational - control) %>%
  summarize_report(aprime_diff)

rts_2x2x2_exptCond <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = exptCond, values_from = rt_pred) %>% 
  mutate(rt_diff = relational - control) %>%
  summarize_report(rt_diff,
                   stat_name = "estimated RT difference", unit_name = "msec")

aprimes_2x2x2_probe <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = probe, values_from = aprime) %>%
  mutate(aprime_diff = room - art) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

rts_2x2x2_probe <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = probe, values_from = rt_pred) %>% 
  mutate(rt_diff = room - art) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")

aprimes_2x2x2_probe_exptCond <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(exptCond, probe), values_from = aprime) %>%
  mutate(aprime_diff_ctrl = control_room - control_art,
         aprime_diff_rel = relational_room - relational_art,
         aprime_diff_probe_exptCond = aprime_diff_rel - aprime_diff_ctrl) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

rts_2x2x2_probe_exptCond <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = c(exptCond, probe), values_from = rt_pred) %>% 
  mutate(rt_diff_ctrl = control_room - control_art,
         rt_diff_rel = relational_room - relational_art,
         rt_diff_probe_exptCond = rt_diff_rel - rt_diff_ctrl) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")
```

**Figure 4.** Coefficient estimates of the model for trialwise match detection performance (i.e., A’). In this model, the main effect of match status reflects the magnitude of behavioral sensitivity across all experimental conditions. Differences in sensitivity between experimental conditions are indexed by interaction terms between match status and the other experimental conditions (i.e., attentional state, condition, and smoking session). Accordingly, predicted A’ (shown below in **Figure 5**) was generated from these coefficients by treating the posterior estimate of P(match endorsement = “yes” | match status = present) as the hit rate, and P(match endorsement = “yes” | match status = absent) as the false alarm rate, in the A’ formula. Error bars = 95% credible intervals.

**Figure 5.** Behavioral performance (A’). Participants’ performance did not differ between OFF and ON smoking sessions for any trial type (each panel = one trial type). Points and faint lines indicate raw A’ values for each participant. Heavy lines and error ribbons indicate group-level model-predicted A’ +- 95% credible interval. Dashed horizontal line indicates chance performance (A’ = 0.5).

_Art vs. Room and Identical vs. Similar Trials._ We next examined how individuals performed across conditions (identical vs. similar trials) and attentional states (art vs. room) in Bayesian mixed models predicting performance as a function of identical vs. similar condition, art vs. room attention type, and on vs. off smoking session (see **Figure 4** for model outputs). As expected, A’ was substantially higher on identical vs. similar trials (**Figure 5**), as indexed by a main effect of condition (`r get_coefs("full", "corResp:exptCond")`; estimated A' difference = `r -aprimes_2x2x2_exptCond$avg`, 95% CI [`r -aprimes_2x2x2_exptCond$q975`, `r -aprimes_2x2x2_exptCond$q025`]). We did not find a comparable main effect of condition on log-RTs (`r get_coefs("full", "exptCond", coefs_rt)`; `r rts_2x2x2_exptCond$txt_apa`).

In contrast, performance was not meaningfully different between art and room attentional states, neither for A’ (`r get_coefs("full", "corResp:probe")`; `r aprimes_2x2x2_probe$txt_apa`) nor for log-RTs (`r get_coefs("full", "corResp:probe", coefs_rt)`; `r rts_2x2x2_probe$txt_apa`).

However, for A’, there was an interaction between condition and attentional state (**Figure 5**), `r get_coefs("full", "corResp:probe:exptCond")`. A’ on identical trials was higher for room vs. art attention (`r aprimes_2x2x2_probe_exptCond %>% filter(metric_type == "ctrl") %>% pull(txt_apa)`), but A’ on similar trials did not meaningfully differ between room vs. art attention (`r aprimes_2x2x2_probe_exptCond %>% filter(metric_type == "rel") %>% pull(txt_apa)`). There was no such interaction for log-RTs, (`r get_coefs("full", "probe:exptCond", coefs_rt)`).

```{r, echo = FALSE}
aprimes_2x2x2_smoking <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = aprime) %>%
  mutate(aprime_diff = on - off) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

rts_2x2x2_smoking <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = on_smoking, values_from = rt_pred) %>% 
  mutate(rt_diff = on - off) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")

aprimes_2x2x2_smoking_simple <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = aprime) %>%
  mutate(aprime_diff = on - off) %>%
  summarize_report(aprime_diff, exptCond, probe)

aprimes_smoking_exptCond <- preplots_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = case_when(name %in% c("dummy_art", "dummy_room") ~ "dummy_attn",
                          startsWith(name, "sep") ~ "sep",
                          TRUE ~ name)) %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, exptCond), values_from = aprime) %>%
  mutate(aprime_diff_ctrl = on_control - off_control,
         aprime_diff_rel = on_relational - off_relational,
         aprime_diff_smoking_exptCond = aprime_diff_rel - aprime_diff_ctrl) %>%
  summarize_report(aprime_diff, name, stat_name = "estimated A' difference")

aprimes_smoking_probe <- preplots_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = case_when(name %in% c("dummy_art", "dummy_room") ~ "dummy_attn",
                          startsWith(name, "sep") ~ "sep",
                          TRUE ~ name)) %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, probe), values_from = aprime) %>%
  mutate(aprime_diff_room = on_room - off_room,
         aprime_diff_art = on_art - off_art,
         aprime_diff_smoking_probe = aprime_diff_room - aprime_diff_art) %>%
  summarize_report(aprime_diff, name, stat_name = "estimated A' difference")

aprimes_smoking_exptCond_probe <- preplots_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = case_when(name %in% c("dummy_art", "dummy_room") ~ "dummy_attn",
                          startsWith(name, "sep") ~ "sep",
                          TRUE ~ name)) %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, exptCond, probe), values_from = aprime) %>%
  mutate(aprime_diff_ctrl_room = on_control_room - off_control_room,
         aprime_diff_ctrl_art = on_control_art - off_control_art,
         aprime_diff_rel_room = on_relational_room - off_relational_room,
         aprime_diff_rel_art = on_relational_art - off_relational_art,
         aprime_diff_ctrl_probe = aprime_diff_ctrl_room - aprime_diff_ctrl_art,
         aprime_diff_rel_probe = aprime_diff_rel_room - aprime_diff_rel_art,
         aprime_diff_exptCond_probe = aprime_diff_rel_probe - aprime_diff_rel_art) %>%
  summarize_report(aprime_diff, name, stat_name = "estimated A' difference")

rts_smoking_exptCond <- preplots_rt_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = case_when(name %in% c("dummy_art", "dummy_room") ~ "dummy_attn",
                          startsWith(name, "sep") ~ "sep",
                          TRUE ~ name)) %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = c(on_smoking, exptCond), values_from = rt_pred) %>%
  mutate(rt_diff_ctrl = on_control - off_control,
         rt_diff_rel = on_relational - off_relational,
         rt_diff_smoking_exptCond = rt_diff_rel - rt_diff_ctrl) %>%
  summarize_report(rt_diff, name, stat_name = "estimated RT difference", unit_name = "msec")

rts_smoking_probe <- preplots_rt_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = case_when(name %in% c("dummy_art", "dummy_room") ~ "dummy_attn",
                          startsWith(name, "sep") ~ "sep",
                          TRUE ~ name)) %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = c(on_smoking, probe), values_from = rt_pred) %>%
  mutate(rt_diff_room = on_room - off_room,
         rt_diff_art = on_art - off_art,
         rt_diff_smoking_probe = rt_diff_room - rt_diff_art) %>%
  summarize_report(rt_diff, name, stat_name = "estimated RT difference", unit_name = "msec")

rts_smoking_exptCond_probe <- preplots_rt_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = case_when(name %in% c("dummy_art", "dummy_room") ~ "dummy_attn",
                          startsWith(name, "sep") ~ "sep",
                          TRUE ~ name)) %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = c(on_smoking, exptCond, probe), values_from = rt_pred) %>%
  mutate(rt_diff_ctrl_room = on_control_room - off_control_room,
         rt_diff_ctrl_art = on_control_art - off_control_art,
         rt_diff_rel_room = on_relational_room - off_relational_room,
         rt_diff_rel_art = on_relational_art - off_relational_art,
         rt_diff_ctrl_probe = rt_diff_ctrl_room - rt_diff_ctrl_art,
         rt_diff_rel_probe = rt_diff_rel_room - rt_diff_rel_art,
         rt_diff_exptCond_probe = rt_diff_rel_probe - rt_diff_rel_art) %>%
  summarize_report(rt_diff, name, stat_name = "estimated RT difference", unit_name = "msec")
```

_Comparison of ON vs OFF smoking sessions._ We then turned to how performance on these tasks might be modulated by nicotine (**Figure 5**). We did not find a main effect of smoking session on A’, (`r get_coefs("full", "corResp:on_smoking")`; `r aprimes_2x2x2_smoking$txt_apa`), suggesting that across trial types, A’ was not consistently higher during the ON session than the OFF session. We also did not find a main effect of smoking session on log-RTs (`r get_coefs("full", "on_smoking", coefs_rt)`; `r rts_2x2x2_smoking$txt_apa`).

Next, we interrogated task-dependent effects of nicotine on performance. Because we initially hypothesized that nicotine would preferentially improve performance on similar room trials, we also examined two-way interactions between smoking session and condition (identical vs. similar) and smoking session and attentional state (art vs. room) on performance. We did not find a two-way interaction effect of smoking session and condition on A’ (`r get_coefs("full", "corResp:on_smoking:exptCond")`) or log-RT (`r get_coefs("full", "on_smoking:exptCond", coefs_rt)`), nor did we find a two-way interaction effect of smoking session and attentional state on A’ (`r get_coefs("full", "corResp:probe:on_smoking")`) or log-RT (`r get_coefs("full", "probe:on_smoking", coefs_rt)`). Finally, an exploratory analysis examining hits and false alarms separately (rather than combined in an A’ score) also failed to show any differences as a function of ON vs OFF smoking sessions.

```{r aprime-by-ppm-stuff, echo = FALSE}
coefs_aprime_by_ppm <- aprime_by_ppm_boot %>%
  select(iteration, model_type, metric_type, exptCond, probe, starts_with("coefs")) %>%
  mutate(coefs_raw = map(coefs_raw, ~rename_if(.x, is.numeric, ~paste0(., "_raw")))) %>% 
  mutate(coefs = map2(coefs_boot, coefs_raw, ~full_join(.x, .y, by = "term"))) %>% 
  select(-coefs_boot, -coefs_raw) %>% 
  unnest(coefs) %>%
  rename(raw = "estimate_raw", perf_metric_type = "metric_type") %>%
  summarize_report(estimate, perf_metric_type, model_type, exptCond, probe, term, raw,
                   stat_name = "beta", unit_name = "ppm units") %>%
  ungroup() %>%
  select(-metric_type) %>% 
  rename(metric_type = "perf_metric_type") %>% 
  mutate(raw = formatC(signif(raw, digits = signif_digits), digits = signif_digits, format = "fg", flag = "#", mode = "double"),
         txt_apa_2 = glue::glue("beta = {raw} ppm units, bootstrapped 95% CI [{q025}, {q975}]"))

pcor_aprime_by_ppm <- aprime_by_ppm_boot %>%
  select(iteration, model_type, metric_type, exptCond, probe, starts_with("resid")) %>%
  unnest(c(resid_value_diff, resid_ppm_diff)) %>%
  group_by(iteration, model_type, metric_type, exptCond, probe) %>%
  summarize(pcor = cor(value_diff_resid, ppm_diff_resid)) %>%
  rename(perf_metric_type = "metric_type") %>%
  summarize_report(pcor, perf_metric_type, model_type, exptCond, probe, stat_name = "partial Pearson correlation") %>%
  select(-metric_type) %>% 
  rename(metric_type = "perf_metric_type") %>% 
  mutate(txt_apa_2 = glue::glue("partial Pearson correlation = {avg}, bootstrapped 95% CI [{q025}, {q975}]"))

# at approx q925 this stuff starts to pop out. not q975
pcor_diff_aprime_by_ppm <- aprime_by_ppm_boot %>%
  select(iteration, model_type, metric_type, exptCond, probe, starts_with("resid")) %>%
  unnest(c(resid_value_diff, resid_ppm_diff)) %>%
  group_by(iteration, model_type, metric_type, exptCond, probe) %>%
  summarize(pcor = cor(value_diff_resid, ppm_diff_resid)) %>%
  ungroup() %>% 
  pivot_wider(names_from = c(exptCond, probe), values_from = pcor) %>%
  mutate(pcor_diff_sa = relational_room - relational_art,
         pcor_diff_ia = relational_room - control_art,
         pcor_diff_ir = relational_room - control_room) %>%
  rename(perf_metric_type = "metric_type") %>%
  summarize_report(pcor_diff, model_type, perf_metric_type, stat_name = "partial Pearson's r difference") %>% 
  mutate(txt_apa_2 = glue::glue("partial Pearson's r difference = {avg}, bootstrapped 95% CI [{q025}, {q975}]"))
```

_Supplementary Models of Performance._ The above analyses model the task as a 2 (condition: identical or similar) x 2 (attentional state: art or room) x 2 (smoking session: OFF or ON) factorial design. Although this has many advantages, there are also statistical disadvantages (see **Methods**). To assess whether our results vary based on statistical modeling approach, we also examined performance ON vs. OFF smoking with two other approaches. The first approach used a model with separate predictors for eight factorial levels of interest (i.e., the OFF and ON smoking sessions for identical art, identical room, similar art, and similar room trials). The second approach used four separate models to examine performance ON vs. OFF smoking in each task separately (one model each for identical art, identical room, similar art, similar room). We found that in these supplementary models, there was still no difference in performance between smoking sessions for any of the tasks. Thus, across multiple statistical modeling approaches, we failed to find a performance benefit ON vs OFF nicotine.

_Individual Differences._ The above analyses treat smoking as a binary variable: they simply compared the ON and OFF smoking sessions. However, more precise information is available about individuals’ smoking, because for each session we obtained measures of expired breath carbon monoxide (CO) parts-per-million (ppm). This tells us how recently or how much an individual smoked, allowing us to investigate possible dose-dependent effects of nicotine smoking (e.g., Vollstädt-Klein et al., 2011; Vossel, Warbrick, Mobascher, Winterer, & Fink, 2011). If nicotine smoking enhances attentional performance, then the individuals who show the greatest CO ppm difference (in the ON vs. OFF smoking session) should show the greatest performance enhancements (in the ON vs. OFF smoking session). To investigate this, we ran four between-participants linear regressions predicting A’ difference as a function of CO ppm difference (ON vs. OFF), with one regression for each task: identical art, identical room, similar art, and similar room.

**Figure 6.** Dose-dependent effects of nicotine smoking on behavioral sensitivity (A’). On similar room trials (bottom right), participants who showed a greater increase in CO ppm from the OFF to the ON smoking session showed larger increases in A’ from the OFF to the ON smoking session. Participants did not show such an effect for identical art, identical room, or similar art trials. Within each panel, each point represents one participant; each participant appears in all four panels. Heavy lines and error ribbons indicate line of best fit +- 95% confidence interval for ON-OFF A' difference vs. ON-OFF CO ppm difference, displayed without adjusting for A' OFF smoking for simplicity. Results are visually indistinguishable when adjusting for A' OFF smoking. * bootstrapped p < .05.

Indeed, we found a modest positive correlation between these measures for the similar room task (`r coefs_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(txt_apa_2)`; `r pcor_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "room") %>% pull(txt_apa_2)`), such that a CO increase of 1 ppm from OFF to ON smoking predicted a `r coefs_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(raw)` unit increase in A’ from OFF to ON smoking (**Figure 6**). We obtained a very similar result when A’ in the OFF session was not included as a predictor variable (`r coefs_aprime_by_ppm %>% filter(model_type == "diffonly", metric_type == "aprime", exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(txt_apa_2)`; `r pcor_aprime_by_ppm %>% filter(model_type == "diffonly", metric_type == "aprime", exptCond == "relational", probe == "room") %>% pull(txt_apa_2)`). CO ppm differences did not predict performance enhancements on any other trial type (identical art: `r coefs_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "control", probe == "art", term == "ppm_diff") %>% pull(txt_apa_2)`, `r pcor_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "control", probe == "art") %>% pull(txt_apa_2)`; identical room: `r coefs_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "control", probe == "room", term == "ppm_diff") %>% pull(txt_apa_2)`, `r pcor_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "control", probe == "room") %>% pull(txt_apa_2)`; similar art: `r coefs_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "art", term == "ppm_diff") %>% pull(txt_apa_2)`, `r pcor_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "art") %>% pull(txt_apa_2)`). Direct comparison showed that the partial Pearson correlation between CO ppm difference and A’ difference ON - OFF smoking for similar room trials was marginally higher than the partial Pearson correlations for the other three trial types (similar room > identical art: `r pcor_diff_aprime_by_ppm %>% filter(model_type == "main", perf_metric_type == "aprime", metric_type == "ia") %>% pull(txt_apa_2)`; similar room > identical room: `r pcor_diff_aprime_by_ppm %>% filter(model_type == "main", perf_metric_type == "aprime", metric_type == "ir") %>% pull(txt_apa_2)`; similar room > similar art: `r pcor_diff_aprime_by_ppm %>% filter(model_type == "main", perf_metric_type == "aprime", metric_type == "sa") %>% pull(txt_apa_2)`).

Finally, an exploratory analysis examining hits and false alarms separately (rather than combined in an A' score) revealed that the smoking-related improvements on similar room trials were mostly driven by a reduction in false alarm rates (`r coefs_aprime_by_ppm %>% filter(model_type == "main", term == "ppm_diff", metric_type == "rate_fa", exptCond == "relational", probe == "room") %>% pull(txt_apa_2)`) rather than a change in hit rates (`r coefs_aprime_by_ppm %>% filter(model_type == "main", term == "ppm_diff", metric_type == "rate_hit", exptCond == "relational", probe == "room") %>% pull(txt_apa_2)`). This result is broadly consistent with studies showing that nicotine can selectively reduce false alarms while not affecting hit rates ([Barr et al., 2007](https://www.nature.com/articles/1301423); [Jubelt et al., 2014](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4078257/)), and nicotinic antagonists can increase false alarms with minimal effects on hits ([Newhouse, Potter, Corwin, & Lenox, 1992](https://link.springer.com/article/10.1007/BF02247425)). However, we made no a priori predictions about hit and false alarm rates, so this pattern of results should be replicated in future studies.

## Supplemental results

### ANOVA version of main logistic mixed models

```{r, echo = FALSE}
anova_out <- aprime_anova %>% 
  summary() %>% 
  .$`Error: Within` %>% 
  pluck(1) %>% 
  set_rownames(str_trim(rownames(.), "right")) %>%
  as_tibble(rownames = "condition") %>% 
  set_names(str_replace(tolower(names(.)), " ", "_")) %>% 
  rename(p_value = "pr(>f)") %>% 
  mutate(df_resid = df[condition == "Residuals"]) %>% 
  filter(condition != "Residuals") %>%
  mutate(txt_df = paste(df, df_resid, sep = ", "),
         txt_f_value = formatC(signif(f_value, digits = signif_digits),
                       digits = signif_digits, format = "fg", flag = "#", mode = "double"),
         txt_p_value = formatC(signif(p_value, digits = signif_digits),
                       digits = signif_digits-1, format = "fg", flag = "#", mode = "double"),
         txt_p_value_full = if_else(p_value < .001, "p < .001", paste0("p = ", txt_p_value)),
         txt_apa = glue::glue("F({txt_df}) = {txt_f_value}, {txt_p_value_full}"))

anova_dfs <- paste(anova_out %>% filter(condition %in% c("exptCond", "Residuals")) %>% pull(df), collapse = ", ")

```

In addition to our analyses based on logistic mixed models, we conducted a more traditional repeated-measures analysis of variance (ANOVA) as a post-hoc, supplementary robustness check. This ANOVA is analogous to our main logistic mixed model (model #1 in Table 1), but uses participant-level A’ as the dependent variable, rather than trialwise yes/no responses. The independent variables were attentional state (art, room), condition (identical, similar), and smoking session (on, off), with all possible main effects, two-way, and three-way interactions. This ANOVA specification is roughly equivalent to a mixed model with only random intercepts for each participant. 

Consistent with our logistic mixed model, the repeated-measures ANOVA revealed a main effect of condition (identical vs. similar; `r anova_out %>% filter(condition == "exptCond") %>% pull(txt_apa)`), and a two-way interaction between condition and attentional state (identical/similar vs. art/room; `r anova_out %>% filter(condition == "exptCond:probe") %>% pull(txt_apa)`). The remaining main effects and interactions were not meaningful (all F(`r anova_out %>% filter(condition == "exptCond:probe:on_smoking") %>% pull(txt_df)`) < `r anova_out %>% filter(condition == "exptCond:probe:on_smoking") %>% pull(txt_f_value)`, all p > `r anova_out %>% filter(condition == "exptCond:probe:on_smoking") %>% pull(txt_p_value)`).  Any post-hoc analyses exploring the directionality of these effects are functionally equivalent to the post-hoc analyses on our logistic mixed models described in the main text. We thus do not report additional post-hoc analyses on this repeated-measures ANOVA.

### Nicotine use covariates

```{r, echo = FALSE}
pca_contrib_percents <- signif(100 * pca_nicotine$sdev^2 / sum(pca_nicotine$sdev^2), digits = signif_digits)
```


We collected a series of self-report measures of chronic nicotine use: the Fagerstrom Test for Nicotine Dependence (FTND), estimated cigarettes smoked/day, and years of smoking. To examine whether these chronic nicotine use variables might affect the relationship between CO ppm ON-OFF and A’ ON-OFF in the similar room task, we first conducted a principal components analysis. This enabled us to explore the correlations between self-reported nicotine use measures and expired breath CO (OFF smoking, ON smoking, and the ON-OFF difference), which in turn allows us to identify covariates that contribute unique information to the between-participants regression. All variables were z-scored before submitting to principal components analysis using R’s stats::prcomp() function. The first two principal components together explained `r sum(pca_contrib_percents[1:2])`% of the total variance. FTND score, cigarettes/day, and all of the CO ppm measures contributed primarily to the first component, while years of smoking contributed to the second component only. The covariance between FTND score, cigarettes/day, and CO ppm makes intuitive sense, because individuals who smoke more cigarettes per day are likely to report higher levels of nicotine dependence and to smoke more prior to the ON session.

**Supplementary Figure 1.** Principal components analysis on nicotine use measures. The first principal component explains `r pca_contrib_percents[1]`% of total variance, while the second component explains `r pca_contrib_percents[2]`%. Length of arrow indexes how well the first two principal components capture the variance in that variable. A variable whose arrow touches the unit circle is completely explained by some combination of the first two components, while a variable with a very short arrow is poorly explained by the first two components. Arrow angle indexes the ratio of contributions of the first two principal components to that variable. A variable whose arrow points along either the x or y axis selectively contributes to the first or second principal components respectively, while a variable whose arrow points at a 45-degree angle contributes equally to the first and second principal components. CO ppm OFF, cigarettes/day, and FTND score contribute almost exclusively to the first component, while CO ppm ON and CO ppm ON - OFF contribute a bit more to the first than the second component. Years of smoking contributes almost exclusively to the second component.

Given that FTND score and cigarettes/day covaried with CO ppm, while years smoking seemed to capture unique information, we opted to use only the years smoking variable as a covariate in the between-participants CO ppm model for similar room trials. This is well justified because using correlated predictors in regression can lead to coefficients that are uninterpretable (Farrar & Glauber, 1967).  Adding years smoking as a covariate to the analyses revealed that reported years of smoking did not predict A’ ON-OFF (`r coefs_aprime_by_ppm %>% filter(model_type == "covar", metric_type == "aprime", exptCond == "relational", probe == "room", term == "years_smoke") %>% pull(txt_apa_2)`). Further, reported years of smoking did not fundamentally alter the effect of CO ppm on A’ ON-OFF (without covariate: `r coefs_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(txt_apa_2)`; with covariate: `r coefs_aprime_by_ppm %>% filter(model_type == "covar", metric_type == "aprime", exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(txt_apa_2)`). The partial Pearson correlation between CO ppm difference and A’ difference ON - OFF smoking was similarly unaffected by years smoking (without covariate: `r pcor_aprime_by_ppm %>% filter(model_type == "main", metric_type == "aprime", exptCond == "relational", probe == "room") %>% pull(txt_apa_2)`; with covariate: `r pcor_aprime_by_ppm %>% filter(model_type == "covar", metric_type == "aprime", exptCond == "relational", probe == "room") %>% pull(txt_apa_2)`). We note that `r english::english(sum(is.na(demos$years_smoke)))` participants were missing reported years of smoking, and were kept in the original regression, but excluded from the regression with the covariate. This reduction in sample size may contribute to the wider CIs observed for the effect of CO ppm in the covariate regression. This analysis therefore does not reveal strong evidence that prolonged nicotine use had an effect on our observed results.

## Not exactly in the main text

These are results whose values are referenced in the main text but not spelled out with numbers.

### converging results from alternate model fits

```{r, echo = FALSE}
# relational on-off room-art A' interaction? from dummy model
# NOT REPORTING
aprimes_dummy_smoking <- preplots_fixef %>%
  filter(name == "dummy_all") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = aprime) %>%
  mutate(aprime_diff = on - off) %>%
  summarize_report(aprime_diff, exptCond, probe)

aprimes_dummy_smoking_probe <- preplots_fixef %>%
  filter(name == "dummy_all") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, probe), values_from = aprime) %>%
  mutate(aprime_diff_room = on_room - off_room,
         aprime_diff_art = on_art - off_art,
         aprime_diff_smoking_probe = aprime_diff_room - aprime_diff_art) %>%
  summarize_report(aprime_diff, exptCond)
```

The predictions are numerically so similar to the main model.

### model fit

Referenced in the statistical methods section.

```{r, echo = FALSE}
errors <- preplots_raw_bysubj %>%
  select(-valid) %>%
  nest(data = -name) %>%
  mutate(raw = data[name == "raw"]) %>%
  filter(name != "raw") %>%
  mutate(data = map2(data, raw,
                     ~full_join(.x, .y, by = c("subj_num", "on_smoking", "exptCond", "probe"), suffix = c("_model", "_raw")))) %>%
  select(-raw) %>%
  unnest(data) %>%
  pivot_longer(cols = c(ends_with("model"), ends_with("raw")), names_to = c("metric_type", ".value"), names_pattern = "(.*)_(.*)") %>%
  mutate(error = model - raw) %>%
  group_by(name, metric_type, on_smoking, exptCond, probe) %>%
  summarize(rmse = sqrt(mean(error ^ 2)),
            mae = median(abs(error))) %>%
  pivot_longer(cols = c(rmse, mae), names_to = "error_type", values_to = "error")

errors_supp <- preplots_raw_bysubj %>%
  filter(name != "raw") %>%
  select(-valid) %>%
  nest(data = -name) %>%
  mutate(model_2x2x2 = data[name == "model_2x2x2"]) %>%
  filter(name != "model_2x2x2") %>%
  mutate(data = map2(data, model_2x2x2,
                     ~full_join(.x, .y, by = c("subj_num", "on_smoking", "exptCond", "probe"), suffix = c("_supp", "_full")))) %>%
  select(-model_2x2x2) %>%
  unnest(data) %>%
  pivot_longer(cols = c(ends_with("supp"), ends_with("full")), names_to = c("metric_type", ".value"), names_pattern = "(.*)_(.*)") %>%
  mutate(error = supp - full) %>%
  group_by(name, metric_type, on_smoking, exptCond, probe) %>%
  summarize(rmse = sqrt(mean(error ^ 2)),
            mae = median(abs(error))) %>%
  pivot_longer(cols = c(rmse, mae), names_to = "error_type", values_to = "error")
```
