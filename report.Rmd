---
title: "report"
author: "Monica Thieu"
date: "3/27/2020"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(rlang)
load(here::here("ignore", "data_R", "raw.rda"))
load(here::here("ignore", "data_R", "boots.rda"))
load(here::here("ignore", "data_R","preplots_rstanarm.rda"))
load(here::here("ignore", "data_R","preplots_rt_rstanarm.rda"))
load(here::here("ignore", "data_R", "aprime_by_ppm.rda"))

this_theme <- function (...) {
  
  out <- theme_bw() +
    theme(plot.title.position = "plot",
          axis.title = element_text(size = rel(1.2)),
          axis.text = element_text(size = rel(1)),
          strip.text = element_text(size = rel(1))) +
    theme(...)
  
  return (out)
}

signif_digits <- 3L
colors_exptCond <- c("#FF1926", "#008a8a")
colors_exptCond_probe <- c("#ff1926", "#008a8a", "#ff9ea3",  "#3acfcf")
```

# Da plotz

03/27/2020: Redo the aprime ppm boot plot with un-adjusted, not the added variable plot, but keep the multiple regression boot stuff for text reporting. Also re-run the boots for more iterations to stabilize the standard error estimates

Done: FIX WHAT YOU HAVE IN THE GLUE CALL TO REPORT THE CORRECT STD ERROR

04/03/2020: Move forward with the unadjusted aprime x ppm plot, beautify it accordingly and possibly??? add significance visual highlight

```{r major-plot-aprime-ppm-boot}
x <- aprime_by_ppm_boot %>%
  select(iteration, exptCond, probe, data_raw) %>%
  unnest(data_raw) %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  group_by(exptCond, probe, obs, ppm_diff, aprime_diff, aprime_diff_fit) %>%
  summarize(boot_median = median(predicted),
            boot_q025 = quantile(predicted, .025),
            boot_q975 = quantile(predicted, .975)) %>%
  mutate(rel_room = if_else(exptCond == "similar" & probe == "room", TRUE, FALSE)) %>%
  ggplot(aes(x = ppm_diff, y = aprime_diff,
             color = interaction(exptCond, probe),
             fill = interaction(exptCond, probe))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", formula = y ~ x, size = 1, alpha = 0.3) +
  geom_text(aes(label = this_label),
            data = crossing(ppm_diff = 5, aprime_diff = -.18,
                            exptCond = c("identical", "similar"), probe = c("art", "room")) %>%
              mutate(this_label = if_else(exptCond == "similar" & probe == "room", "*", "")),
            size = 10, color = "black") +
  scale_color_manual(values = colors_exptCond_probe) +
  scale_fill_manual(values = colors_exptCond_probe) +
  facet_grid(probe ~ exptCond) +
  guides(color = FALSE, fill = FALSE) +
  labs(x = "CO ppm ON - CO ppm OFF smoking",
       y = "A' ON - A' OFF smoking",
       title = "unadjusted plot of ppm_diff") +
  this_theme()

x

x %>%
  ggsave(filename = "ignore/figures/major_plot_aprime_by_ppm.png",
       plot = .,
       device = "png",
       width = 6,
       height = 6)
```

```{r minor-plot-aprime-ppm-resid-boot}
aprime_by_ppm_boot %>%
  select(iteration, exptCond, probe, data_raw) %>%
  unnest(data_raw) %>%
  group_by(exptCond, probe, obs, ppm_diff_resid, aprime_diff_resid, aprime_diff_fit_resid) %>%
  summarize(boot_median = median(predicted),
            boot_q025 = quantile(predicted, .025),
            boot_q975 = quantile(predicted, .975)) %>%
  mutate(rel_room = if_else(exptCond == "relational" & probe == "room", TRUE, FALSE)) %>%
  ggplot(aes(x = ppm_diff_resid, y = aprime_diff_resid, color = rel_room, fill = rel_room)) +
  geom_point(alpha = 0.5) +
  geom_ribbon(aes(ymin = boot_q025, ymax = boot_q975), color = FALSE, alpha = 0.3) +
  geom_line(aes(y = aprime_diff_fit_resid), size = 1) +
  geom_text(aes(label = glue::glue("beta = {estimate_raw}\n95% boot int = [{boot_q025}, {boot_q975}]")),
            data = aprime_by_ppm_boot %>%
              mutate(coefs = map2(coefs, coefs_raw, ~full_join(.x, .y, by = "term"))) %>%
              select(iteration, exptCond, probe, coefs) %>%
              unnest(coefs) %>%
              group_by(exptCond, probe, term, estimate_raw) %>%
              summarize(boot_median = median(estimate),
                        boot_mean = mean(estimate),
                        boot_q025 = quantile(estimate, .025),
                        boot_q975 = quantile(estimate, .975)) %>%
              mutate_if(is.numeric, signif, digits = signif_digits) %>%
              filter(term == "ppm_diff") %>%
              mutate(rel_room = if_else(exptCond == "relational" & probe == "room", TRUE, FALSE)),
            x = 9, y = -0.5, hjust = 1) +
  # geom_smooth(method = "lm", fill = "blue") +
  facet_grid(probe ~ exptCond) +
  guides(color = FALSE, fill = FALSE) +
  labs(x = "ppm_diff | aprime_off",
       y = "aprime_diff | aprime_off",
       title = "added variable plot of ppm_diff") +
  theme_bw()
```

03/27/2020: Investigate this graph... what is up with the bootstrap error distributions not being centered on the raw values

Update 03/31/2020: Refer to relevant exploratory graphs in the analysis document. Basically, the people with shitty off-smoking A' and a huge improvement in A', AND the people with great off-smoking A' and a huge reduction in A', are more likely to get bootstrap-resampled with relatively extreme values, driving the center of the bootstrap distribution of the A' off predictor higher. Additionally, intercepts and A' off slopes are correlated in the bootstrap distribution because the convergence point of the lines is above chance A'.

```{r minor-plot-aprime-ppm-coefplot-boot}
aprime_by_ppm_boot %>%
  mutate(coefs = map2(coefs, coefs_raw, ~full_join(.x, .y, by = "term"))) %>%
  select(iteration, exptCond, probe, coefs) %>%
  unnest(coefs) %>%
  mutate(term = recode_factor(term,
                              `(Intercept)` = "Intercept",
                              aprime_off_c = "A' OFF smoking",
                              ppm_diff = "ON - OFF change in CO ppm")) %>%
  group_by(exptCond, probe, term, estimate_raw) %>%
  summarize(boot_median = median(estimate),
            boot_mean = mean(estimate),
            boot_q025 = quantile(estimate, .025),
            boot_q25 = quantile(estimate, .25),
            boot_q75 = quantile(estimate, .75),
            boot_q975 = quantile(estimate, .975)) %>%
  ggplot(aes(x = boot_median, y = "term")) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_errorbarh(aes(xmin = boot_q025, xmax = boot_q975), height = 0) +
  geom_errorbarh(aes(xmin = boot_q25, xmax = boot_q75), height = 0, size = 1) +
  geom_point() +
  geom_point(aes(x = boot_mean), color = "purple") +
  geom_point(aes(x = estimate_raw), color = "hotpink") +
  facet_grid(exptCond + probe ~ term, scales = "free_x") +
  labs(x = "coefficient (unit effect on ON-OFF A' difference)",
       y = "model term",
       title = "model: A' diff ~ A' off (center = 0.5) + ppm diff (raw units)") +
  theme_bw()
```

```{r minor-plot-2x2x2-coefs}
x <- preplots_params %>%
  filter(startsWith(name, "full")) %>%
  unnest(iterations) %>%
  mutate(term = recode_factor(term,
                              intercept = "intercept",
                              corResp = "match present?",
                              exptCond = "condition",
                              probe = "attention type",
                              on_smoking = "smoking status",
                              `corResp:exptCond` = "match present? x condition",
                              `corResp:probe` = "match present? x attention",
                              `corResp:on_smoking` = "match present? x smoking",
                              `probe:exptCond` = " condition x attention",
                              `on_smoking:exptCond` = "condition x smoking",
                              `probe:on_smoking` = "attention x smoking",
                              `corResp:probe:exptCond` = "match present? x condition x attention",
                              `corResp:on_smoking:exptCond` = "match present? x condition x smoking",
                              `corResp:probe:on_smoking` = "match present? x attention x smoking",
                              `probe:on_smoking:exptCond` = "condition x attention x smoking")) %>%
  group_by(term) %>%
  summarize(est_median = median(estimate),
            est_q025 = quantile(estimate, .025),
            est_q25 = quantile(estimate, .25),
            est_q75 = quantile(estimate, .75),
            est_q975 = quantile(estimate, .975)) %>%
  ggplot(aes(x = est_median, y = fct_rev(term))) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_errorbarh(aes(xmin = est_q025, xmax = est_q975), height = 0) +
  geom_errorbarh(aes(xmin = est_q25, xmax = est_q75), size = 1, height = 0) +
  geom_point() +
  labs(x = "coefficient +- posterior interval", y = NULL,
       title = "visual coefficients/SEs for 2x2x2 model",
       subtitle = "thick error bars: 50% PI; thin error bars: 95% PI") +
  this_theme(plot.title.position = "panel")

x

x %>%
  ggsave("ignore/figures/minor_plot_2x2x2_coefs.png",
         plot = .,
         device = "png",
         width = 7,
         height = 4.5,
         units = "in")
```

03/27/2020: use the mean for the below plot. And add a figure b for this one omitting the raw data with sensibly truncated axes

red for control, blue for relational. lighter for art, darker for room. get Nick's illustrator CMYK codes for the conditions

04/03/2020: fix the color char vector to put the colors in the right order, also tweak opacity etc to get stuff to be darker

```{r major-plot-nick}
x <- preplots_raw_bysubj %>%
  filter(name == "raw") %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  ggplot(aes(x = on_smoking, y = aprime, color = interaction(exptCond, probe), fill = interaction(exptCond, probe))) +
  geom_line(aes(group = subj_num), alpha = 0.1) +
  geom_jitter(width = 0.1, alpha = 0.2) +
  geom_ribbon(aes(y = aprime_mean, ymin = aprime_q025, ymax = aprime_q975, group = 1),
              data = preplots_fixef %>%
              filter(name == "full") %>%
                mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
              group_by(on_smoking, exptCond, probe) %>%
              summarize(aprime_mean = mean(aprime),
                        aprime_q025 = quantile(aprime, .025),
                        aprime_q975 = quantile(aprime, .975)),
              linetype = 0,
              alpha = 0.3) +
  geom_line(aes(group = 1),
            data = preplots_fixef %>%
              filter(name == "full") %>%
              mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
              group_by(on_smoking, exptCond, probe) %>%
              summarize(aprime = mean(aprime)),
            size = 1,
            alpha = 1) +
  geom_hline(yintercept = 0.5, linetype = 3) +
  scale_color_manual(values = colors_exptCond_probe) +
  scale_fill_manual(values = colors_exptCond_probe) +
  labs(x = "Smoking session",
       y = "A'",
       title = "Figure N",
       subtitle = "putative cholinergic modulation of A'") +
  guides(color = FALSE, fill = FALSE) +
  facet_grid( ~ exptCond + probe) +
  this_theme()

x

x %>%
  ggsave(filename = "ignore/figures/major_plot_nick.png",
       plot = .,
       device = "png",
       width = 7,
       height = 4.5)
```

04/03/2020: Make another version of this plot with 95% ribbons instead of paired angel hair. Also tinker with the angel hair plot to make things more visible. Plus add manual color legend for dark vs light

```{r minor-plot-nick-truncated}
preplots_fixef %>%
  filter(name == "full") %>%
  nest(data = -iteration) %>%
  sample_n(300) %>%
  unnest(data) %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  ggplot(aes(x = on_smoking, y = aprime, color = interaction(exptCond, probe))) +
  geom_line(aes(group = interaction(iteration, probe)), alpha = 0.05) +
  geom_line(aes(group = probe),
            data = preplots_fixef %>%
              filter(name == "full") %>%
              mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
              group_by(on_smoking, exptCond, probe) %>%
              summarize(aprime = mean(aprime)),
            size = 1.5,
            alpha = 0.8) +
  scale_color_manual(values = colors_exptCond_probe) +
  labs(x = "Smoking session",
       y = "A'",
       title = "Figure Nb",
       subtitle = "putative cholinergic modulation of A'") +
  facet_grid( ~ exptCond) +
  this_theme()
```

```{r minor-plot-nick-truncated-ribbon}
x <- preplots_fixef %>%
  filter(name == "full") %>%
  mutate(exptCond = recode(exptCond, control = "identical", relational = "similar")) %>%
  group_by(on_smoking, exptCond, probe) %>%
              summarize(aprime_mean = mean(aprime),
                        aprime_q025 = quantile(aprime, .025),
                        aprime_q975 = quantile(aprime, .975)) %>%
  ggplot(aes(x = on_smoking, y = aprime_mean,
             color = interaction(exptCond, probe),
             fill = interaction(exptCond, probe))) +
  geom_ribbon(aes(ymin = aprime_q025, ymax = aprime_q975, group = probe),
              linetype = 0,
              alpha = 0.25) +
  geom_line(aes(group = probe),
            size = 1.5,
            alpha = 0.8) +
  geom_text(aes(label = probe),
            data = crossing(on_smoking = 1.5,
                            exptCond = c("identical", "similar"), probe = c("art", "room")) %>%
              mutate(aprime_mean = case_when(exptCond == "identical" & probe == "room" ~ .88,
                                             exptCond == "identical" & probe == "art" ~ .86,
                                             exptCond == "similar" & probe == "room" ~ .9,
                                             exptCond == "similar" & probe == "art" ~ .92)),
            size = 6) +
  scale_color_manual(values = colors_exptCond_probe) +
  scale_fill_manual(values = colors_exptCond_probe) +
  guides(color = FALSE, fill = FALSE) +
  labs(x = "Smoking session",
       y = "A'",
       title = "Figure Nb",
       subtitle = "putative cholinergic modulation of A'") +
  facet_grid( ~ exptCond) +
  this_theme()

x

x %>%
  ggsave(filename = "ignore/figures/minor_plot_nick_truncated.png",
       plot = .,
       device = "png",
       width = 5,
       height = 4)
```

# Da resultz

1. **minor result**: Report valid > invalid A' from `manip_check`
1. **major result**: describe various ctrl/rel room/art things
1. **major result**: describe on/off smoking differences
1. **minor result**: describe converging results from alternate model fits
1. **minor result**: relational on-off room-art A' interaction? from dummy model (introduce said model also)
1. **major result**: A' by ppm diffs bootstrap biznaz

04/03/2020:

- Harmonize terminology with what Nick is reporting in the patient manuscript returned for response to review
- report for all estimates, mean [q025, q975]
- report RT for `manip_check` analysis also
- generally, where appropriate, interleave RT results in with A' results. In general, do not break RT out by response accuracy, just by task conditions

```{r, echo = FALSE}
summarize_report <- function (data, col, ..., stat_name = "", unit_name = "", digs = signif_digits) {
  if (unit_name != "") unit_name %<>% paste0(" ", .)
  glue_in = if_else(stat_name != "",
                    "{stat_name} = {a}{unit_name}, 95% CI [{b}, {c}]",
                    "{a}{unit_name}, 95% CI [{b}, {c}]")
  
  col_chr = as_name(enexpr(col))
  group_cols = enexprs(...)
  
  data %<>%
    select(iteration, !!!group_cols, starts_with(col_chr)) %>%
    pivot_longer(cols = starts_with(col_chr),
                 names_to = "metric_type",
                 values_to = "value",
                 names_prefix = glue::glue("{col_chr}_"))
  
  if (!is.null(group_cols)) {
    data %<>% group_by(!!!group_cols, metric_type)
  } else {
    data %<>% group_by(metric_type)
  }
  data %<>%
    summarize(avg = mean(value),
              q025 = quantile(value, .025),
              q975 = quantile(value, .975)) %>% 
    mutate_at(c("avg", "q025", "q975"), signif, digits = digs) %>%
    mutate(txt_apa = pmap_chr(list(avg, q025, q975),
                              function (a, b, c) {glue::glue(glue_in)}
    )
    )
  
  return (data)
}

coefs <- preplots_params %>%
  unnest(iterations) %>%
  summarize_report(estimate, name, term, stat_name = "beta")

coefs_rt <- preplots_rt_params %>%
  unnest(iterations) %>%
  summarize_report(estimate, name, term, stat_name = "beta")

get_coefs <- function (model_name, model_term, these_coefs = coefs) {
  these_coefs %>%
    filter(name == model_name, term == model_term) %>%
    pull(txt_apa)
}
```

```{r, echo = FALSE}
aprimes_manip_check <- preplots_fixef %>%
  filter(name == "manip_check") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = valid, values_from = aprime, names_prefix = "aprime_") %>% 
  mutate(aprime_diff = aprime_1 - aprime_0) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

rts_manip_check <- preplots_rt_fixef %>%
  filter(name == "manip_check") %>%
  pivot_wider(names_from = valid, values_from = ends_with("rt_pred")) %>% 
  mutate(rt_diff = rt_pred_1 - rt_pred_0) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")
```

_Valid vs. Invalid Trials._ We first examined whether our attentional manipulation was successful by comparing performance on valid vs. invalid trials. If attention is effectively engaged by the cue at the beginning of the trial (i.e., ‘ART’ or ‘ROOM’), then performance should be more accurate and faster when the probe matches the cue (i.e., valid trials) than when it does not (i.e., invalid trials; Posner, 1980). These analyses confirmed that participants were more accurate on valid vs. invalid trials (`r get_coefs("manip_check", "corResp:valid")`; `r aprimes_manip_check$txt_apa`). Furthermore, an analysis of log-transformed response times (RTs) confirmed that participants were faster on valid vs. invalid trials (`r get_coefs("manip_check", "valid", coefs_rt)`; `r rts_manip_check$txt_apa`).

Taken together, these results suggest that attention was effectively engaged by the cue at the beginning of the trial: Participants were more accurate and faster on valid vs. invalid trials. Having verified that participants modulated their attention based on trial instructions, we next focus analyses on valid trials.

```{r, echo = FALSE}
aprimes_2x2x2_exptCond <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = exptCond, values_from = aprime) %>%
  mutate(aprime_diff = relational - control) %>%
  summarize_report(aprime_diff)

rts_2x2x2_exptCond <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = exptCond, values_from = rt_pred) %>% 
  mutate(rt_diff = relational - control) %>%
  summarize_report(rt_diff,
                   stat_name = "estimated log-RT difference", unit_name = "msec")

aprimes_2x2x2_probe <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = probe, values_from = aprime) %>%
  mutate(aprime_diff = room - art) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

rts_2x2x2_probe <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = probe, values_from = rt_pred) %>% 
  mutate(rt_diff = room - art) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")

aprimes_2x2x2_probe_exptCond <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(exptCond, probe), values_from = aprime) %>%
  mutate(aprime_diff_ctrl = control_room - control_art,
         aprime_diff_rel = relational_room - relational_art,
         aprime_diff_probe_exptCond = aprime_diff_rel - aprime_diff_ctrl) %>%
  summarize_report(aprime_diff, stat_name = "estimated A' difference")

rts_2x2x2_probe_exptCond <- preplots_rt_fixef %>%
  filter(name == "full") %>%
  select(-log_rt_pred) %>%
  pivot_wider(names_from = c(exptCond, probe), values_from = rt_pred) %>% 
  mutate(rt_diff_ctrl = control_room - control_art,
         rt_diff_rel = relational_room - relational_art,
         rt_diff_probe_exptCond = rt_diff_rel - rt_diff_ctrl) %>%
  summarize_report(rt_diff, stat_name = "estimated RT difference", unit_name = "msec")
```

**Art vs. Room and Identical vs. Similar Trials.** We next examined how individuals performed across conditions (identical vs. similar trials) and attentional states (art vs. room) in a Bayesian mixed model predicting accuracy as a function of identical vs. similar condition, art vs. room attention type, and on vs. off smoking session. As expected, A’ was substantially higher on identical vs. similar trials, as indexed by a main effect of condition (`r get_coefs("full", "corResp:exptCond")`; estimated A' difference = `r -aprimes_2x2x2_exptCond$avg`, 95% CI [`r -aprimes_2x2x2_exptCond$q975`, `r -aprimes_2x2x2_exptCond$q025`]). We did not find a comparable main effect of condition on log-RTs (`r get_coefs("full", "exptCond", coefs_rt)`; `r rts_2x2x2_exptCond$txt_apa`).

In contrast, performance was not meaningfully different between art and room attentional states, neither for A’ (`r get_coefs("full", "corResp:probe")`; `r aprimes_2x2x2_probe$txt_apa`) nor for log-RTs (`r get_coefs("full", "corResp:probe", coefs_rt)`; `r rts_2x2x2_probe$txt_apa`).

However, for A’, there was an interaction between condition and attentional state, `r get_coefs("full", "corResp:probe:exptCond")`. A’ on identical trials was higher for room vs. art attention (`r aprimes_2x2x2_probe_exptCond %>% filter(metric_type == "ctrl") %>% pull(txt_apa)`), but A’ on similar trials did not meaningfully differ between room vs. art attention (`r aprimes_2x2x2_probe_exptCond %>% filter(metric_type == "rel") %>% pull(txt_apa)`). There was no such interaction for log-RTs, (`r get_coefs("full", "probe:exptCond", coefs_rt)`; HOW TO REPORT THIS STAT IN PARALLEL?).




## describe on/off smoking differences

```{r, echo = FALSE}
aprimes_2x2x2_smoking <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = aprime) %>%
  mutate(aprime_diff = on - off) %>%
  summarize_report(aprime_diff)

aprimes_2x2x2_smoking_simple <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = aprime) %>%
  mutate(aprime_diff = on - off) %>%
  summarize_report(aprime_diff, exptCond, probe)

aprimes_2x2x2_smoking_exptCond <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, exptCond), values_from = aprime) %>%
  mutate(aprime_diff_ctrl = on_control - off_control,
         aprime_diff_rel = on_relational - off_relational,
         aprime_diff_smoking_exptCond = aprime_diff_rel - aprime_diff_ctrl) %>%
  summarize_report(aprime_diff)

aprimes_2x2x2_smoking_probe <- preplots_fixef %>%
  filter(name == "full") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, probe), values_from = aprime) %>%
  mutate(aprime_diff_room = on_room - off_room,
         aprime_diff_art = on_art - off_art,
         aprime_diff_smoking_probe = aprime_diff_room - aprime_diff_art) %>%
  summarize_report(aprime_diff, exptCond)
```

We did not find a main effect of smoking session on A', `r get_coefs("full", "corResp:on_smoking")`, suggesting that across trial types, A' was not consistently higher during the ON session than the OFF session. More specifically, we estimated an ON - OFF smoking A' difference of `r aprimes_2x2x2_smoking$txt_apa`.

We also did not find a main effect of smoking session on RT, `r get_coefs("full", "on_smoking", coefs_rt)`.

## describe converging results from alternate model fits

We used the model with main effects and interactions of match status, probe similarity type, attentional state, and smoking session, as the relationships between sub-conditions implied by the model align best with a theoretical model proposing that some consistent construct underlies performance on, e.g., all similar match trials relative to all identical match trials. However, any model specification carries with it particular side effects, which may be advantages or limitations depending on the context. In this case, by  using interaction terms to match our model to the factorial design of the task, estimates are assumed to be more similar for factorial conditions sharing a level. For example, the estimates for similar art match trials OFF smoking are regularized to be closer to estimates for other similar match trials, other art match trials, and other OFF smoking trials. Such a model allows us to make true factorial inferences, arguably the most powerful, about the effects of our manipulations.

However, the constraining effects of a factorial model specification may cause the model to _underestimate_ the magnitude of a simple effect. For example, if there were a true underlying ON-smoking improvement in working memory accuracy, but only for one of the 2 x 2 factorial levels of probe similarity type x attentional state, the absence of the simple effect in three of the four factorial levels would cause the model to estimate the magnitude of the simple effect in the fourth level too conservatively, thus reducing our ability to detect such an effect.

An alternative model specification that mitigates this concern is a dummy-coded model. In a dummy-coded model, each factorial level is instead treated as an independent level of a single variable. As such, simple effects are not constrained by the model to be similar for similar factorial levels, allowing the model to be more liberal in estimating an effect that only appears in a single level. For this reason, we estimated a supplementary model with two predictors: one predictor for match status, and one predictor for task condition with 8 levels, one for each factorial combination of smoking session, probe similarity type, and attentional state (2 x 2 x 2 = 8), to probe for simple effects.

To further reduce factorial model constraints, we estimated a final set of four supplementary models, each with match status and smoking session as predictors. Each model was estimated on a different subset of data for each of the 2 x 2 = 4 factorial levels of probe similarity type x attentional state. These models are the most liberal in allowing the estimated effect of smoking session on working memory accuracy to differ across levels of probe similarity and attentional state.

Given that all models with the same predictors on the same outcome are ultimately only different flavors of quantifying the same underlying patterns present in the data, alternative model specifications should yield qualitatively similar estimates as our primary model. 

```{r, echo = FALSE}
# relational on-off room-art A' interaction? from dummy model
# NOT REPORTING
aprimes_dummy_smoking <- preplots_fixef %>%
  filter(name == "dummy_all") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = aprime) %>%
  mutate(aprime_diff = on - off) %>%
  summarize_report(aprime_diff, exptCond, probe)

aprimes_dummy_smoking_probe <- preplots_fixef %>%
  filter(name == "dummy_all") %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = c(on_smoking, probe), values_from = aprime) %>%
  mutate(aprime_diff_room = on_room - off_room,
         aprime_diff_art = on_art - off_art,
         aprime_diff_smoking_probe = aprime_diff_room - aprime_diff_art) %>%
  summarize_report(aprime_diff, exptCond)
```

## A' diff by ppm diff

```{r, echo = FALSE}
coefs_aprime_by_ppm <- aprime_by_ppm_boot %>%
  mutate(coefs = map2(coefs, coefs_raw, ~full_join(.x, .y, by = "term"))) %>%
  select(iteration, exptCond, probe, coefs) %>%
  unnest(coefs) %>%
  rename(raw = "estimate_raw") %>%
  summarize_report(estimate, exptCond, probe, term, raw)
```


04/10/2020 just Monica: Move the first paragraph of this section to methods?

To expand upon our primary analyses treating smoking session as a binary variable, we leveraged our carbon monoxide parts per million measurements to investigate possible dose-dependent effects of smoking nicotine on A' in various task conditions. To this end, we ran four independent, between-subjects linear regressions, one each for the four factorial task levels of condition x attention type. Each regression predicted each participant's A' difference ON - OFF smoking in that task condition as a function of their CO ppm difference ON - OFF smoking, with a nuisance regressor of each participant's "baseline" A' OFF smoking, to adjust for possible regression to the mean.

We found that CO ppm difference ON - OFF smoking modestly positively predicted A' difference ON - OFF smoking, beta = `r coefs_aprime_by_ppm %>% filter(exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(raw)`, hierarchical bootstrapped 95% CI [`r coefs_aprime_by_ppm %>% filter(exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(q025)`, `r coefs_aprime_by_ppm %>% filter(exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(q975)`], such that a CO increase of 1 ppm from off to on smoking predicted a `r coefs_aprime_by_ppm %>% filter(exptCond == "relational", probe == "room", term == "ppm_diff") %>% pull(raw)` increase in A' from off to on smoking. Post-hoc visual inspection reveals that this effect may be driven by participants with minimal on-smoking ppm increases being more likely to show a decrease in A' from off to on smoking.

### model fit

Should be moved to the statistical methods section but the code will stay here for now just in case

```{r, echo = FALSE}
errors <- preplots_raw_bysubj %>%
  select(-valid) %>%
  nest(data = -name) %>%
  mutate(raw = data[name == "raw"]) %>%
  filter(name != "raw") %>%
  mutate(data = map2(data, raw,
                     ~full_join(.x, .y, by = c("subj_num", "on_smoking", "exptCond", "probe"), suffix = c("_model", "_raw")))) %>%
  select(-raw) %>%
  unnest(data) %>%
  pivot_longer(cols = c(ends_with("model"), ends_with("raw")), names_to = c("metric_type", ".value"), names_pattern = "(.*)_(.*)") %>%
  mutate(error = model - raw) %>%
  group_by(name, metric_type, on_smoking, exptCond, probe) %>%
  summarize(rmse = sqrt(mean(error ^ 2)),
            mae = median(abs(error))) %>%
  pivot_longer(cols = c(rmse, mae), names_to = "error_type", values_to = "error")
```

To assess model fit and validate subsequent inferences from the model, we used the model to generate each subject's posterior predicted A' in each task condition, and calculated the errors between predicted A' and raw A' for each subject x condition. We examined median absolute error, as median absolute error does not up-weight extremely large errors, as does root-mean-squared error. Median absolute error was below 0.05 A' units across subjects in seven of eight factorial task conditions.
