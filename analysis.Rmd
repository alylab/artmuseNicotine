---
title: "multilevel smokers art gallery analyses"
author: "Monica Thieu"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(magrittr)
options(mc.cores = parallel::detectCores())

demos = read_csv("ignore/demographics/demo_smoke_habits.csv") %>%
  mutate(cigs_per_day_est = 10 * cigs_per_day_est) %>%
  mutate_if(is.numeric, as.integer) %>%
  mutate(cigs_per_day_est = .1 * cigs_per_day_est,
         ppm_on = if_else(condition == 1, ppm_s1, ppm_s2),
         ppm_off = if_else(condition == 1, ppm_s2, ppm_s1))

raw = tibble(filename = list.files("ignore/data_raw", pattern = ".txt", full.names = TRUE)) %>%
  mutate(data = map(filename, ~.x %>%
                      read_delim(delim = "\t",
                                 skip = 9,
                                 col_names = FALSE) %>%
                      select(trial = X1,
                             stimOnsetTime = X2,
                             exptCond = X4,
                             stimNum = X6,
                             cue = X7,
                             probe = X8,
                             valid = X9,
                             resp = X10,
                             corResp = X11,
                             acc = X12,
                             rt = X13) %>%
                      mutate_at(c("trial", "exptCond", "valid", "resp", "corResp", "acc"),
                                as.integer) %>%
                    mutate_at(c("cue", "probe"), ~recode(., `1` = "art", `2` = "room")))) %>%
  mutate(subj_num = as.integer(str_sub(filename, start = 32L, end = 34L)),
         session_num = str_sub(filename, start = -5L, end = -5L),
         session_num = if_else(session_num == "2", 2L, 1L)) %>%
  select(-filename) %>%
  left_join(demos %>%
              select(subj_num, condition, ppm_on, ppm_off) %>%
              pivot_longer(names_to = "on_smoking", values_to = "ppm", cols = starts_with("ppm")) %>% 
              mutate(on_smoking = recode(on_smoking, ppm_on = 1L, ppm_off = 0L),
                     ppm_z = c(scale(ppm))),
            by = "subj_num") %>%
  # Scrub all subjects who don't appear in demographics data
  filter(!is.na(condition)) %>%
  mutate(on_smoking = as.integer(session_num == condition)) %>%
  unnest(data)
```

## checking data quality

```{r}
# Should be 0 length
raw %>%
  count(subj_num, on_smoking) %>%
  filter(n < 80)
```

For eyeballing:

```{r}
raw %>%
  group_by(subj_num, on_smoking, corResp) %>%
  summarize(mean_acc = mean(acc)) %>%
  pivot_wider(names_from = corResp, values_from = mean_acc, names_prefix = "rate_") %>%
  rename(rate_cr = rate_0, rate_hit = rate_1) %>%
  mutate(rate_fa = 1 - rate_cr) %>%
  ggplot(aes(x = rate_hit, y = rate_fa, color = factor(on_smoking))) +
  geom_point()
```

## model fittin

As of 02/05/2020: Keep the original "onoff" model, and add one where the two-way interactions with `corResp` are allowed to vary by subject as well, then do all the model diagnosis stuff per usual

```{r, eval = FALSE}
models <- tibble(name = c("onoff", "ppm", "control", "relational"),
                 has_exptCond = list(0:1, 1L, 0L, 1L),
                 has_smoking = c("on_smoking", "ppm_z", "on_smoking", "on_smoking")) %>%
  mutate(data = map(has_exptCond, ~raw %>%
                      filter(valid == 1, exptCond %in% .x)),
         terms = map_if(has_exptCond, lengths(has_exptCond) > 1,
                        ~c("corResp", "probe", "exptCond"),
                        .else = ~c("corResp", "probe")),
         terms = map2(terms, has_smoking, ~c(.x, .y)),
         txt_formula = map_chr(terms, ~paste(.x, collapse = " + ")),
         txt_formula = paste0("resp ~ (", txt_formula, ")^3 + (1 + corResp | subj_num)"),
         model = map2(txt_formula, data, ~rstanarm::stan_glmer(as.formula(.x),
                                                               family = binomial(link = "logit"),
                                                               data = .y,
                                                               prior = rstanarm::cauchy(0, 5),
                                                               prior_intercept = rstanarm::cauchy(0, 5))))

save(models, file = "ignore/data_R/models_rstanarm.rda")
```

```{r}
load("ignore/data_R/models_rstanarm.rda")
```

## results preppin

```{r}
preplots_params <- models %>%
  select(name, iterations = model) %>%
  mutate(iterations = map(iterations, ~.x %>%
                            as.data.frame() %>%
                            as_tibble() %>%
                            mutate(iteration = 1:nrow(.)) %>%
                            select(-contains("["), -contains("sigma")) %>%
                            rename(intercept = "(Intercept)") %>%
                            pivot_longer(cols = -iteration, names_to = "term", values_to = "estimate")))
```

```{r}
preplots_bysubj <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select("subj_num", .y) %>% distinct()),
         predicted = map2(model, data, ~.x %>%
                            rstanarm::posterior_linpred(transform = TRUE,
                                                        newdata = .y,
                                                        re.form = NULL,
                                                        draws = 1000)),
         predicted = map(predicted, ~apply(.x, 2, median) %>% t() %>% c()),
         predicted = map2(data, predicted, ~.x %>%
                            mutate(resp_pred = .y,
                                   corResp = recode(corResp, `0` = "fa", `1` = "hit")) %>%
                            pivot_wider(names_from = corResp,
                                        values_from = resp_pred,
                                        names_prefix = "rate_") %>%
                            mutate(dprime = qnorm(rate_hit) - qnorm(rate_fa)))) %>%
  select(name, predicted)
```

```{r}
preplots_fixef <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select(.y) %>% distinct()),
         predicted = map2(model, data, ~.x %>%
                            rstanarm::posterior_linpred(transform = TRUE,
                                                        newdata = .y,
                                                        re.form = NA,
                                                        draws = 1000)),
         # Must expand AFTER predictions is already done to repeat for iterations
         data = map(data, ~.x %>%
                      mutate(obs = 1:nrow(.),
                             iteration = map(obs, ~1:1000)) %>%
                      unchop(iteration)),
         predicted = map(predicted, ~.x %>%
                           as_tibble() %>%
                           mutate(iteration = 1:nrow(.)) %>%
                           pivot_longer(cols = -iteration, names_to = "obs", values_to = "resp_pred") %>%
                           mutate(obs = as.integer(obs))),
         predicted = map2(data, predicted, ~left_join(.x, .y, by = c("obs", "iteration"))),
         predicted = map(predicted, ~.x %>%
                           select(-obs) %>%
                           mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit")) %>%
                           pivot_wider(names_from = corResp,
                                       values_from = resp_pred,
                                       names_prefix = "rate_") %>%
                           mutate(dprime = qnorm(rate_hit) - qnorm(rate_fa)))) %>%
  select(name, predicted)
```

## results graphin

### parameter estimates

Just parameter estimates from model 1, where both control and relational trials are included and `exptCond` is used as a predictor to look at interactions of d' and allllll conditions.

```{r}
preplots_params$iterations[[1]] %>%
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_vline(aes(xintercept = estimate),
             data = preplots_params$iterations[[1]] %>%
               group_by(term) %>%
               summarize(estimate = median(estimate)),
             color = "hotpink",
             linetype = 3) +
  facet_wrap(~ term, scales = "free")
```

Comparing the relational only binary smoking model and relational only ppm model. The ppm model basically appears to be a drastically less stable version of the binary smoking model.

```{r}
preplots_params %>%
  filter(name %in% c("ppm", "relational")) %>%
  unnest(iterations) %>%
  mutate(term = if_else(name == "ppm",
                        str_replace(term, "ppm_z", "smoking"),
                        str_replace(term, "on_smoking", "smoking"))) %>%
  ggplot(aes(x = estimate)) +
  geom_histogram(aes(fill = name), position = "identity", alpha = 0.4) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_vline(aes(xintercept = estimate, color = name),
             data = preplots_params %>%
               filter(name %in% c("ppm", "relational")) %>%
               unnest(iterations) %>%
               mutate(term = if_else(name == "ppm",
                                     str_replace(term, "ppm_z", "smoking"),
                                     str_replace(term, "on_smoking", "smoking"))) %>%
               group_by(name, term) %>%
               summarize(estimate = median(estimate)),
             linetype = 3) +
  facet_wrap(~ term, scales = "free")
```

### Plotting predicted d' and stuff

#### by subject

```{r}
preplots_bysubj$predicted[[1]] %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  ggplot(aes(x = on_smoking, y = dprime, color = probe)) +
  geom_line(aes(group = interaction(subj_num, probe))) +
  geom_point() +
  facet_grid(probe ~ exptCond)
```

```{r}
preplots_bysubj$predicted[[1]] %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  ggplot(aes(x = on_smoking, y = rate_hit, color = probe)) +
  geom_line(aes(group = interaction(subj_num, probe))) +
  geom_point() +
  facet_grid(~exptCond)
```

```{r}
preplots_bysubj %>%
  filter(name != "ppm") %>%
  unnest(predicted) %>%
  mutate(exptCond = case_when(name == "control" ~ 0L,
                              name == "relational" ~ 1L,
                              TRUE ~ exptCond),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  ggplot(aes(x = interaction(probe, on_smoking, exptCond), y = dprime, color = name)) +
  geom_line(aes(group = name)) +
  geom_point() +
  facet_wrap(~subj_num) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

#### fixed effects over everyone

```{r}
preplots_fixef$predicted[[1]] %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on")) %>%
  ggplot(aes(x = probe, y = dprime, color = exptCond, fill = exptCond)) +
  geom_jitter(alpha = 0.1) +
  geom_violin(position = "identity", alpha = 0.5) +
  facet_grid(~ on_smoking)
```

```{r}
preplots_fixef$predicted[[1]] %>%
  select(-obs) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit")) %>%
  pivot_wider(names_from = corResp, values_from = resp_pred, names_prefix = "rate_") %>%
  mutate(dprime = qnorm(rate_hit) - qnorm(rate_fa)) %>%
  ggplot(aes(x = probe, y = dprime, color = factor(exptCond))) +
  geom_jitter(alpha = 0.3) +
  facet_grid(~ on_smoking)
```
