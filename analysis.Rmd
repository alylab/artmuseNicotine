---
title: "multilevel smokers art gallery analyses"
author: "Monica Thieu"
date: "1/22/2020"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(magrittr)
require(rlang)
options(mc.cores = parallel::detectCores())
future::plan("multiprocess")

snodgrass <- function (num, denom) return((num+.5)/(denom+1))
snodgrass_vec <- function (vec) return((sum(vec) + 0.5) / (length(vec) + 1))
sdt_pr <- function (hit, fa) return(hit - fa)
sdt_br <- function(hit, fa) return(fa / (1 - (hit - fa)))
sdt_aprime <- function (hit, fa) return(.5 + (sign(hit-fa)*((hit-fa)^2 + abs(hit-fa))/(4*pmax(hit,fa)-(4*hit*fa))))
sdt_b2prime <- function (hit, fa)  return(sign(hit-fa)*(hit*(1-hit) - fa*(1-fa))/(hit*(1-hit) + fa*(1-fa)))
sdt_dprime <- function (hit, fa) return(qnorm(hit) - qnorm(fa))
sdt_c <- function (hit, fa) return(-.5 * (qnorm(hit) + qnorm(fa)))

posterior_preplot_params <- function (object) {
  out <- object %>%
    as.data.frame() %>%
    as_tibble() %>%
    mutate(iteration = 1:nrow(.)) %>%
    # removes all random effects and sigma terms. should yield fixed effects only
    select(-contains("["), -contains("sigma")) %>%
    rename(intercept = "(Intercept)") %>%
    pivot_longer(cols = -iteration, names_to = "term", values_to = "estimate")
  
  return (out)
}

posterior_preplot_bysubj <- function (object, newdata, pred_col = "y_pred", type = c("median", "mean", "by_iter", "trialwise"), draws = 1000) {
  # if (type == "trialwise" & draws > 10) stop("too many posterior_predict draws, probably!")
  if (type != "trialwise") {
    out <- object %>%
    rstanarm::posterior_linpred(transform = TRUE,
                                newdata = newdata,
                                re.form = NULL,
                                draws = draws)
  } else {
    out <- object %>%
      rstanarm::posterior_predict(newdata = newdata,
                                  draws = draws,
                                  re.form = NULL)
  }
  if (type == "by_iter") {
    
    newdata %<>%
      # Must expand AFTER predictions is already done to repeat for iterations
      # need the "obs" column to make damn sure that the correct predicted points get pasted on the correct x values
      mutate(obs = 1:nrow(.),
             iteration = map(obs, ~1:draws)) %>%
      unchop(iteration)
    
    out %>%
      as_tibble() %>%
      mutate(iteration = 1:nrow(.)) %>%
      pivot_longer(cols = -iteration, names_to = "obs", values_to = pred_col) %>%
      mutate(obs = as.integer(obs)) %>%
      right_join(newdata, by = c("obs", "iteration")) %>%
      # the obs column obstructs any later pivoting, and is technically redundant if all the x cols are in there,
      # so get outta here
      select(-obs)
    
    return(out)
    
  } else if (type == "median" | type == "mean") {
    # Just the median of every predicted point for every subject
    # Note that this doesn't select in a paired way for the "median iteration"
    # returns a VECTOR which needs to get slapped onto newdata
    if (type == "median") {
      out %<>%
      apply(2, median)
    } else if (type == "mean") {
      out %<>%
      apply(2, mean)
    }
    out %<>%
      t() %>%
      c()
    
    newdata %<>%
      mutate(!!pred_col := out)
    
    return (newdata)
  } else if (type == "trialwise") {
    
    newdata %<>%
      # Must expand AFTER predictions is already done to repeat for iterations
      # need the "obs" column to make damn sure that the correct predicted points get pasted on the correct x values
      mutate(obs = 1:nrow(.))
    
    out %<>%
      t() %>%
      as_tibble(.name_repair = "universal") %>%
      mutate(obs = 1:nrow(.)) %>%
      right_join(newdata, by = "obs") %>%
      pivot_longer(cols = starts_with("..."), names_to = "iteration", values_to = pred_col) %>%
      mutate(iteration = as.integer(str_sub(iteration, start = 4L))) %>%
      # the obs column obstructs any later pivoting, and is technically redundant if all the x cols are in there,
      # so get outta here
      select(-obs)
    
    if (length(unique(out$iteration)) == 1) out %<>% select(-iteration)
    
    return(out)
    
  }
  
}

posterior_preplot_fixef <- function (object, newdata, pred_col = "y_pred", draws = 1000) {
  
  out <- object %>%
    rstanarm::posterior_linpred(transform = TRUE,
                                newdata = newdata,
                                re.form = NA,
                                draws = draws)
  
  newdata %<>%
    # Must expand AFTER predictions is already done to repeat for iterations
    # need the "obs" column to make damn sure that the correct predicted points get pasted on the correct x values
    mutate(obs = 1:nrow(.),
           iteration = map(obs, ~1:draws)) %>%
    unchop(iteration)
  
  out %<>%
    as_tibble() %>%
    mutate(iteration = 1:nrow(.)) %>%
    pivot_longer(cols = -iteration, names_to = "obs", values_to = pred_col) %>%
    mutate(obs = as.integer(obs)) %>%
    right_join(newdata, by = c("obs", "iteration")) %>%
    # the obs column obstructs any later pivoting, and is technically redundant if all the x cols are in there,
    # so get outta here
    select(-obs)
  
  return(out)
}

demos = read_csv("ignore/demographics/demo_smoke_habits.csv") %>%
  mutate(cigs_per_day_est = 10 * cigs_per_day_est) %>%
  mutate_if(is.numeric, as.integer) %>%
  mutate(cigs_per_day_est = .1 * cigs_per_day_est,
         ppm_on = if_else(condition == 1, ppm_s1, ppm_s2),
         ppm_off = if_else(condition == 1, ppm_s2, ppm_s1))

raw = tibble(filename = list.files("ignore/data_raw", pattern = ".txt", full.names = TRUE)) %>%
  mutate(data = map(filename, ~.x %>%
                      read_delim(delim = "\t",
                                 skip = 9,
                                 col_names = FALSE) %>%
                      select(trial = X1,
                             stimOnsetTime = X2,
                             exptCond = X4,
                             stimNum = X6,
                             cue = X7,
                             probe = X8,
                             valid = X9,
                             resp = X10,
                             corResp = X11,
                             acc = X12,
                             rt = X13) %>%
                      mutate_at(c("trial", "exptCond", "valid", "resp", "corResp", "acc"),
                                as.integer) %>%
                    mutate_at(c("cue", "probe"), ~recode(., `1` = "art", `2` = "room")))) %>%
  mutate(subj_num = as.integer(str_sub(filename, start = 32L, end = 34L)),
         session_num = str_sub(filename, start = -5L, end = -5L),
         session_num = if_else(session_num == "2", 2L, 1L)) %>%
  select(-filename) %>%
  left_join(demos %>%
              select(subj_num, condition, ppm_on, ppm_off) %>%
              pivot_longer(names_to = "on_smoking", values_to = "ppm", cols = starts_with("ppm")) %>% 
              mutate(on_smoking = recode(on_smoking, ppm_on = 1L, ppm_off = 0L),
                     # move session_num to 0 and 1, I gotta plan
                     condition_reverse = if_else(condition == 1L, 2L, 1L),
                     session_num = if_else(on_smoking == 1, condition, condition_reverse),
                     ppm_z = c(scale(ppm))),
            by = c("subj_num", "session_num")) %>%
  select(-condition_reverse) %>%
  # Scrub all subjects who don't appear in demographics data
  filter(!is.na(condition)) %>%
  # mutate(on_smoking = as.integer(session_num == condition)) %>%
  unnest(data)
```

## checking data quality

```{r}
# Should be 0 length
raw %>%
  count(subj_num, on_smoking) %>%
  filter(n < 80)
```

For eyeballing:

```{r}
raw %>%
  group_by(subj_num, on_smoking, corResp) %>%
  summarize(mean_acc = mean(acc)) %>%
  pivot_wider(names_from = corResp, values_from = mean_acc, names_prefix = "rate_") %>%
  rename(rate_cr = rate_0, rate_hit = rate_1) %>%
  mutate(rate_fa = 1 - rate_cr) %>%
  ggplot(aes(x = rate_hit, y = rate_fa, color = factor(on_smoking))) +
  geom_point()
```

## Purely descriptive statistix

Pretty sure most of these hinge on manually calculating A'/d' and such.

03/18/2020:

- Look over RT analyses this way before fitting the big models to RT
- check for improvement between first and second session

### Manually calculating SDT metrics: Craazy right?

```{r}
sdt_metrics <- raw %>%
  filter(valid == 1) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on"),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  group_by(subj_num, on_smoking, exptCond, cue, corResp) %>%
  summarize(rate = mean(resp), snod = snodgrass_vec(resp), n_trials = n()) %>%
  pivot_wider(names_from = corResp, values_from = c(rate, snod)) %>%
  mutate(aprime = sdt_aprime(rate_hit, rate_fa),
         aprime_snod = sdt_aprime(snod_hit, snod_fa),
         dprime = sdt_dprime(snod_hit, snod_fa),
         pr = sdt_pr(rate_hit, rate_fa))

save(raw, sdt_metrics, file = here::here("ignore", "data_R", "raw.rda"))
```

```{r}
sdt_metrics %>%
  ggplot(aes(x = aprime, y = aprime_snod)) +
  geom_abline(slope = 1, intercept = 0, linetype = 3) +
  geom_point(alpha = 0.5)
```

```{r}
sdt_metrics %>%
  ggplot(aes(x = aprime, y = dprime)) +
  geom_point(alpha = 0.5)
```

```{r}
sdt_metrics %>%
  ggplot(aes(x = aprime_snod, y = dprime)) +
  geom_point(alpha = 0.5)
```

Doing the `qnorm()` transform as d' does introduces nonlinearity into the SDT metrics, predictably. But they are still basically Spearman rho >= 0.97.

```{r}
sdt_metrics %>%
  ggplot(aes(x = exptCond, y = aprime, color = cue)) +
  geom_line(aes(group =interaction(subj_num, cue)), alpha = 0.5) +
  geom_point() +
  facet_grid(~ on_smoking)
```

Attempting to recreate the original "significant" statistic from Nick's descriptive analysis

```{r}
sdt_metrics %>%
  ungroup() %>%
  select(subj_num:cue, aprime) %>%
  ggplot(aes(x = on_smoking, y = aprime)) +
  geom_line(aes(group = subj_num), alpha = 0.2) +
  geom_line(aes(group = 1),
            data = sdt_metrics %>%
              ungroup() %>%
              select(subj_num:cue, aprime) %>%
              group_by(on_smoking, cue, exptCond) %>%
              summarize(aprime = median(aprime)),
            size = 1) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = 3) +
  facet_grid(~ exptCond + cue)
```

```{r}
sdt_metrics %>%
  ungroup() %>%
  mutate(on_smoking = fct_rev(on_smoking)) %>%
  select(subj_num:cue, rate_hit, rate_fa) %>%
  pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
  ggplot(aes(x = on_smoking, y = rate)) +
  geom_line(aes(group = subj_num), alpha = 0.2) +
  geom_line(aes(group = 1),
            data = sdt_metrics %>%
              ungroup() %>%
              select(subj_num:cue, rate_hit, rate_fa) %>%
              pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
              group_by(on_smoking, cue, exptCond, rate_type) %>%
              summarize(rate = mean(rate)),
            size = 1) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = 3) +
  facet_grid(rate_type ~ exptCond + cue)
```

### ppm diff ~ A' diff

02/21/2020: Recreate Nick's correlation, but not by doing difference ~ difference

03/18/2020:

- **major plot**: residualized A' difference ~ raw ppm difference
- **minor plot**: coefplot of A' diff ~ A' off + ppm diff models for each of the 4 conditions

```{r}
aprime_by_ppm <- raw %>%
  filter(valid == 1) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on"),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  group_by(subj_num, ppm, on_smoking, exptCond, probe, corResp) %>%
  summarize(rate = mean(resp)) %>%
  pivot_wider(names_from = corResp, values_from = rate, names_prefix = "rate_") %>%
  mutate(aprime = sdt_aprime(rate_hit, rate_fa)) %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = c(aprime, ppm)) %>%
  mutate(ppm_diff = ppm_on - ppm_off,
         aprime_diff = aprime_on - aprime_off,
         aprime_off_c = aprime_off - 0.5) %>%
  arrange(exptCond, probe, aprime_off, aprime_diff) %>%
  group_by(exptCond, probe) %>%
  mutate(rank_aprime_off = 1:n()) %>%
  nest(data = -c(exptCond, probe)) %>%
  mutate(resid_aprime_diff = map(data, ~lm(aprime_diff ~ aprime_off_c, data = .x) %>%
                                   broom::augment() %>%
                                   select(aprime_diff_resid = .resid)),
         resid_ppm_diff = map(data, ~lm(ppm_diff ~ aprime_off_c, data = .x) %>%
                                broom::augment() %>%
                                select(ppm_diff_resid = .resid)),
         data = pmap(list(data, resid_aprime_diff, resid_ppm_diff),
                     function(a, b, c) {bind_cols(a, b, c)}),
         model = map(data, ~lm(aprime_diff ~ aprime_off_c + ppm_diff, data = .x)),
         augs = map(model, ~.x %>%
                            broom::augment() %>%
                            select(aprime_diff_fit = .fitted)),
         resid_augs = map(data, ~lm(aprime_diff_resid ~ ppm_diff_resid, data = .x) %>%
                            broom::augment() %>%
                            select(aprime_diff_fit_resid = .fitted)),
         data = map2(data, augs, ~bind_cols(.x, .y)),
         data = map2(data, resid_augs, ~bind_cols(.x, .y))) %>%
  select(-starts_with("resid"), -augs)
```

```{r}
aprime_by_ppm %>%
  select(-model) %>%
  unnest(data) %>%
  ggplot(aes(x = ppm_z_diff, y = aprime_diff)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(probe ~ exptCond) +
  labs("Direct recreation of Nick's original A' diff ~ ppm diff result")
```

```{r}
aprime_by_ppm %>%
  select(-model) %>%
  unnest(data) %>%
  ggplot(aes(x = rank_aprime_off)) +
  geom_errorbar(aes(ymin = aprime_off, ymax = aprime_on), width = 0) +
  geom_point(aes(y = aprime_off)) +
  facet_grid(probe ~ exptCond)
  
  # geom_smooth(method = "lm")
```

### correlation matrices

03/13/2020: Get these correlation matrices from Nick

```{r}
var = "aprime"
sym_var = sym(var)

sdt_metrics %>%
  select(subj_num, on_smoking, exptCond, probe = cue, {{sym_var}}) %>%
  unite(col = trial_type, on_smoking, exptCond, probe) %>%
  ungroup() %>%
  pivot_wider(values_from = {{sym_var}}, names_from = trial_type) %>%
  select(-subj_num) %>%
  cor() %>%
  as_tibble(rownames = "row") %>%
  pivot_longer(cols = -row, names_to = "col", values_to = "correlation") %>%
  mutate(correlation = na_if(correlation, 1)) %>%
  ggplot(aes(x = fct_rev(col), y = row, fill = correlation)) +
  geom_raster() +
  viridis::scale_fill_viridis() +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

```{r}
sdt_metrics %>%
  select(subj_num, on_smoking, exptCond, probe = cue, {{sym_var}}) %>%
  unite(col = trial_type, on_smoking, exptCond, probe) %>%
  ungroup() %>%
  pivot_wider(values_from = {{sym_var}}, names_from = trial_type) %>%
  select(-subj_num) %>%
  prcomp() %>%
  factoextra::fviz_pca_var(col.var = "contrib")
```


## bootstrap analysis

To relieve memory stress, trialwise bootstrap information will _not_ be retained in the final form of this model object. I tried briefly to figure out how to use `rsample::bootstraps()` to do this, but it doesn't seem to readily support hierarchical 2-level bootstrapping. One could do full-on cluster bootstrapping by `nest()`-ing to get one row per subject, and then _just_ resample subjects, leaving intact their responses on particular trials. However, I want to reproduce 2-level uncertainty on the between and within-subject level. Here goes.

```{r, eval = FALSE}
boots_by_subj <- raw %>%
  filter(valid == 1) %>%
  select(-c(valid, session_num, condition, cue)) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on"),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  nest(trials = -c(subj_num, ppm, on_smoking, exptCond, probe, corResp)) %>%
  nest(conditions = -subj_num) %>%
  nest(subjects = everything()) %>%
  # note that here, 1:n() is 1:1
  slice(rep(1:n(), each = 200)) %>%
  mutate(iteration = 1:n(),
         # resample outer level: subjects
         subjects = furrr::future_map(subjects, ~sample_frac(.x, size = 1, replace = TRUE) %>%
                          mutate(subj_num = 1:nrow(.)),
                          .progress = TRUE)) %>%
  unnest(subjects) %>%
  unnest(conditions) %>%
  # CHANGE N BOOTSTRAPS HERE
  # resample inner level: trials (honoring condition structure)
  mutate(boots = furrr::future_map(trials, ~rsample::bootstraps(.x, times = 1) %>%
                       mutate(rate = map_dbl(splits, ~mean(as.data.frame(.x)$resp))) %>% 
                       select(rate),
                       .progress = TRUE)) %>%
  select(-trials) %>%
  unnest(boots) %>%
  pivot_wider(names_from = corResp, values_from = rate, names_prefix = "rate_") %>%
  mutate(aprime = sdt_aprime(rate_hit, rate_fa),
         aprime = coalesce(aprime, 0.5)) %>%
  nest(data = -iteration)

boots_by_trial <- raw %>%
  filter(valid == 1) %>%
  select(-c(valid, session_num, condition, cue)) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on"),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  nest(trials = -c(subj_num, on_smoking, exptCond, probe, corResp)) %>%
  # CHANGE N BOOTSTRAPS HERE
  # resample inner level: trials (honoring condition structure)
  mutate(boots = furrr::future_map(trials, ~rsample::bootstraps(.x, times = 100) %>%
                       mutate(iteration = 1:nrow(.),
                              rate = map_dbl(splits, ~mean(as.data.frame(.x)$resp))) %>% 
                       select(iteration, rate),
                       .progress = TRUE)) %>%
  select(-trials) %>%
  unnest(boots) %>%
  pivot_wider(names_from = corResp, values_from = rate, names_prefix = "rate_") %>%
  mutate(aprime = sdt_aprime(rate_hit, rate_fa),
         # if both hit and FA rates are 0 or 1, it NaNs out, but imputing 0.5
         # makes sense here since they should technically be at chance
         aprime = coalesce(aprime, 0.5)) %>%
  group_by(subj_num, on_smoking, exptCond, probe) %>%
  summarize_at(c("rate_hit", "rate_fa", "aprime"),
               list(q05 = ~quantile(., .05),
                    q25 = ~quantile(., .25),
                    q50 = ~median(.),
                    q75 = ~quantile(., .75),
                    q95 = ~quantile(., .95))) %>%
  pivot_longer(cols = contains("_q"), names_to = c("metric_type", ".value"),
               names_pattern = "(.*)_(...)")

save(boots_by_subj, boots_by_trial, file = here::here("ignore", "data_R", "boots.rda"))
```

```{r}
load("ignore/data_R/boots.rda")
```

```{r}
boots_by_trial %>%
  filter(metric_type == "aprime") %>%
  ggplot(aes(x = interaction(on_smoking, exptCond, probe), y = q50)) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0) +
  geom_point() +
  geom_point(aes(y = aprime),
             data = sdt_metrics %>%
               rename(probe = cue),
             color = "hotpink") +
  facet_wrap(~ subj_num) +
  labs(title = "big ass 50% bootstrap SEs")
```

### Standard errors on Nick's Plots (tm)

03/05/2020: Generate, from the bootstrap distribution as they have been generated from the model estimates:

- standard errors around the "Nick's plots" for A', hit rate, FA rate
- all the difference of difference test statistics

### Difference of differences

```{r}
diffs_boot <- boots_by_subj %>%
  unnest(data) %>%
  # need to remove this to let the summarizing do its thing properly
  select(-ppm_z) %>%
  arrange(iteration, subj_num, probe, exptCond, on_smoking) %>%
  group_by(iteration, subj_num, probe, exptCond) %>%
  summarize(diff_rate_fa = diff(rate_fa),
            diff_rate_hit = diff(rate_hit),
            diff_aprime = diff(aprime)) %>%
  pivot_longer(starts_with("diff"), names_to = "metric_type", values_to = "diff_smoking", names_prefix = "diff_") %>%
  # group_by(iteration, probe, exptCond, metric_type) %>%
  # summarize(median_diff_smoking = median(diff_smoking),
  #           mean_diff_smoking = mean(diff_smoking)) %>%
  nest(diffs = -c(probe, exptCond, metric_type)) %>%
  left_join(sdt_metrics %>%
              rename(probe = cue) %>%
              arrange(subj_num, probe, exptCond, on_smoking) %>%
              group_by(subj_num, probe, exptCond) %>%
              summarize(diff_rate_fa = diff(rate_fa),
                        diff_rate_hit = diff(rate_hit),
                        diff_aprime = diff(aprime)) %>%
              ungroup() %>%
              pivot_longer(starts_with("diff"), names_to = "metric_type", values_to = "diff_smoking", names_prefix = "diff_") %>%
              group_by(probe, exptCond, metric_type) %>%
              summarize(raw_median_diff_smoking = median(diff_smoking),
                        raw_mean_diff_smoking = mean(diff_smoking)),
            by = c("probe", "exptCond", "metric_type"))
```

just diff smoking:

```{r}
diffs_boot %>%
  select(probe, exptCond, metric_type, diffs) %>%
  unnest(diffs) %>%
  group_by(iteration, probe, exptCond, metric_type) %>%
  summarize(median_diff_smoking = median(diff_smoking),
            mean_diff_smoking = mean(diff_smoking)) %>%
  ggplot(aes(x = median_diff_smoking, fill = probe)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = 3) +
  facet_grid(exptCond ~ metric_type, scales = "free_x")
```

diff smoking probe:

diff smoking exptCond:

diff smoking probe exptCond:

### sign tests

02/14/2020: Run Matlab-style `signtest()` on the on-off difference data to recreate Nick's original result

02/21/2020: finish the above point, but definitely do it on the iteration-level by-subject predicted A'/hit rate/FA rates

Above CORRECTED to run on bootstrapped data instead

```{r}
signtests <- sdt_metrics %>%
  select(subj_num, exptCond, probe = cue, on_smoking, aprime, rate_hit, rate_fa) %>%
  pivot_longer(c(aprime, rate_hit, rate_fa), names_to = "metric_type", values_to = "value") %>%
  pivot_wider(names_from = on_smoking, values_from = value, names_prefix = "value_") %>%
  mutate(value_diff = value_on - value_off,
         sign_value_diff = sign(value_diff),
         sign_value_diff = na_if(sign_value_diff, 0)) %>%
  nest(data = -c(metric_type, exptCond, probe)) %>%
  mutate(signtest_x = map_int(data, ~sum(.x$sign_value_diff == 1 & !is.na(.x$sign_value_diff))),
         signtest_n = map_int(data, ~sum(!is.na(.x$sign_value_diff))),
         signtest = map2(signtest_x, signtest_n, ~binom.test(x = .x,
                                                             n = .y,
                                                             alternative = "two.sided")),
         p_value = map_dbl(signtest, ~pluck(.x, "p.value")),
         estimate = map_dbl(signtest, ~pluck(.x, "estimate")),
         conf_lower = map_dbl(signtest, ~pluck(.x, "conf.int", 1)),
         conf_higher = map_dbl(signtest, ~pluck(.x, "conf.int", 2)))

signtests_boot <- boots_by_subj %>%
  unnest(data) %>%
  select(-ppm_z) %>%
  pivot_longer(c(rate_hit, rate_fa, aprime),
               names_to = "metric_type", values_to = "value") %>%
  pivot_wider(values_from = value, names_from = on_smoking, names_prefix = "value_") %>%
  mutate(value_diff = value_on - value_off,
         sign_value_diff = sign(value_diff),
         sign_value_diff = na_if(sign_value_diff, 0)) %>%
  nest(data = -c(iteration, metric_type, exptCond, probe)) %>%
  mutate(signtest_x = map_int(data, ~sum(.x$sign_value_diff == 1 & !is.na(.x$sign_value_diff))),
         signtest_n = map_int(data, ~sum(!is.na(.x$sign_value_diff))),
         signtest = map2(signtest_x, signtest_n,
                         ~binom.test(x = .x, n = .y, alternative = "two.sided")),
         p_value = map_dbl(signtest, ~pluck(.x, "p.value")),
         estimate = map_dbl(signtest, ~pluck(.x, "estimate")),
         conf_lower = map_dbl(signtest, ~pluck(.x, "conf.int", 1)),
         conf_higher = map_dbl(signtest, ~pluck(.x, "conf.int", 2))) %>%
  group_by(metric_type, exptCond, probe) %>%
  arrange(estimate, conf_lower) %>%
  mutate(est_rank = 1:n())

signtests_boot %>%
  mutate(significance = p_value < .05) %>%
  ggplot(aes(x = est_rank, y = estimate, color = significance)) +
  geom_hline(yintercept = .5, linetype = 3) +
  geom_errorbar(aes(ymin = conf_lower, ymax = conf_higher), width = 0.1, alpha = 0.5) +
  geom_point(size = 0.5) +
  geom_hline(aes(yintercept = estimate),
             data = signtests,
             linetype = 3,
             color = "springgreen4") +
  # scale_color_gradient2(low = "turquoise", mid = "black", high = "hotpink", midpoint = 0.5) +
  facet_grid(exptCond + probe ~ metric_type) +
  labs(title = "ON - OFF smoking binomial sign test estimates") +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

```{r}
wilcoxtests <- sdt_metrics %>%
  select(subj_num, exptCond, probe = cue, on_smoking, aprime, rate_hit, rate_fa) %>%
  pivot_longer(c(aprime, rate_hit, rate_fa), names_to = "metric_type", values_to = "value") %>%
  pivot_wider(names_from = on_smoking, values_from = value, names_prefix = "value_") %>%
  nest(data = -c(metric_type, exptCond, probe)) %>%
  mutate(test = map(data, ~wilcox.test(x = .x$value_on,
                                       y = .x$value_off,
                                       exact = FALSE,
                                       paired = TRUE,
                                       alternative = "two.sided")),
         p_value = map_dbl(test, ~pluck(.x, "p.value")),
         estimate = map_dbl(test, ~pluck(.x, "statistic")))

wilcoxtests_boot <- boots_by_subj %>%
  unnest(data) %>%
  select(-ppm_z) %>%
  pivot_longer(c(rate_hit, rate_fa, aprime),
               names_to = "metric_type", values_to = "value") %>%
  pivot_wider(values_from = value, names_from = on_smoking, names_prefix = "value_") %>%
  nest(data = -c(iteration, metric_type, exptCond, probe)) %>%
  mutate(test = map(data, ~wilcox.test(x = .x$value_on,
                                       y = .x$value_off,
                                       exact = FALSE,
                                       paired = TRUE,
                                       alternative = "two.sided")),
         p_value = map_dbl(test, ~pluck(.x, "p.value")),
         estimate = map_dbl(test, ~pluck(.x, "statistic"))) %>%
  group_by(metric_type, exptCond, probe) %>%
  arrange(estimate) %>%
  mutate(est_rank = 1:n())

wilcoxtests_boot %>%
  mutate(significance = p_value < .05) %>%
  ggplot(aes(x = est_rank, y = estimate, color = significance)) +
  geom_hline(yintercept = .5, linetype = 3) +
  geom_point(size = 0.5) +
  geom_hline(aes(yintercept = estimate),
             data = wilcoxtests,
             linetype = 3,
             color = "springgreen4") +
  # scale_color_gradient2(low = "turquoise", mid = "black", high = "hotpink", midpoint = 0.5) +
  facet_grid(exptCond + probe ~ metric_type) +
  labs(title = "ON - OFF smoking Wilcoxon test statistics") +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

### A' diff ~ A' off + ppm diff

```{r}
aprime_by_ppm_boot <- boots_by_subj %>%
  unnest(data) %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = c(aprime, ppm)) %>%
  mutate(ppm_diff = ppm_on - ppm_off,
         aprime_diff = aprime_on - aprime_off,
         aprime_off_c = aprime_off - 0.5) %>%
  nest(data = -c(iteration, exptCond, probe)) %>%
  mutate(resid_aprime_diff = map(data, ~lm(aprime_diff ~ aprime_off_c, data = .x) %>% broom::augment() %>% select(aprime_diff_resid = .resid)),
         resid_ppm_diff = map(data, ~lm(ppm_diff ~ aprime_off_c, data = .x) %>% broom::augment() %>% select(ppm_diff_resid = .resid)),
         data = pmap(list(data, resid_aprime_diff, resid_ppm_diff), function(a, b, c) {bind_cols(a, b, c)}),
         model = map(data, ~lm(aprime_diff ~ aprime_off_c + ppm_diff, data = .x)),
         model_resid = map(data, ~lm(aprime_diff_resid ~ ppm_diff_resid, data = .x)),
         coefs = map(data, ~lm(aprime_diff ~ aprime_off_c + ppm_diff, data = .x) %>%
                       broom::tidy()),
         coefs_unadj = map(data, ~lm(aprime_diff ~ ppm_diff, data = .x) %>%
                       broom::tidy())) %>%
  left_join(aprime_by_ppm %>%
              select(exptCond, probe, data_raw = data, coefs_raw = model) %>%
              mutate(coefs_raw = map(coefs_raw,
                                     ~broom::tidy(.) %>%
                                       rename_if(is.numeric, ~paste0(., "_raw")))),
            by = c("exptCond", "probe")) %>%
  mutate(predicted_resid = map2(data_raw, model_resid,
                                ~.x %>%
                                  select(ppm_diff_resid) %>%
                                  predict(.y, newdata = .)),
         data_raw = map2(data_raw, predicted_resid,
                         ~.x %>%
                           mutate(obs = 1:nrow(.), predicted = .y))) %>%
    select(-ends_with("resid"), -data)

save(aprime_by_ppm, aprime_by_ppm_boot, file = here::here("ignore", "data_R", "aprime_by_ppm.rda"))
```

```{r}

  # unnest(coefs) %>%
  # arrange(exptCond, probe, term, estimate) %>%
  # group_by(exptCond, probe, term) %>%
  # mutate(rank_estimate = 1:n())

aprime_by_ppm_boot %>%
  mutate(significance = p.value < .05) %>%
  ggplot(aes(x = rank_estimate, y = estimate, color = significance)) +
  geom_hline(yintercept = 0, linetype = 3) +
  geom_errorbar(aes(ymin = estimate - 2*std.error,
                    ymax = estimate + 2*std.error), 
                alpha = 0.5, width = 0) +
  geom_point() +
  geom_hline(aes(yintercept = estimate),
             data = aprime_by_ppm %>%
               mutate(coefs = map(model, broom::tidy)) %>%
               select(-data, -model) %>%
               unnest(coefs),
             color = "hotpink",
             linetype = 2) +
  facet_grid(term ~ exptCond + probe, scales = "free_y")
  
```

```{r}
aprime_by_ppm_boot %>%
  filter(term == "ppm_z_diff") %>%
  mutate(significance = p.value < .05) %>%
  ggplot(aes(x = estimate)) +
  geom_histogram(bins = 20) +
  facet_grid( ~ exptCond + probe, scales = "free_x")
```

```{r}
aprime_by_ppm_boot %>%
    mutate(coefs = map2(coefs, coefs_raw, ~full_join(.x, .y, by = "term"))) %>%
    select(iteration, exptCond, probe, coefs) %>%
    unnest(coefs) %>%
  ggplot(aes(x = estimate)) +
  geom_histogram(bins = 40) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_vline(aes(xintercept = estimate_raw), linetype = 3, color = "hotpink") +
  facet_grid(exptCond + probe ~ term, scales = "free_x") +
  theme_bw()
```

```{r}
boots_by_subj %>%
  unnest(data) %>%
  select(-starts_with("rate")) %>%
  pivot_wider(names_from = on_smoking, values_from = c(ppm, aprime)) %>%
  mutate(ppm_diff = ppm_on - ppm_off,
         aprime_diff = aprime_on - aprime_off,
         aprime_off_c = aprime_off - 0.5) %>%
  ggplot(aes(x = aprime_off_c, y = aprime_diff, color = factor(iteration))) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, size = 0.5) +
  geom_point(data = aprime_by_ppm %>% unnest(data), color = "black") +
  geom_smooth(data = aprime_by_ppm %>% unnest(data),
              method = "lm", formula = y ~ x, se = FALSE, size = 0.5, color = "black") +
  guides(color = FALSE) +
  facet_grid(probe ~ exptCond)
```


```{r major-plot-aprime-ppm-resid}
aprime_by_ppm %>%
  select(-model) %>%
  unnest(data) %>%
  ggplot(aes(x = ppm_diff_resid, y = aprime_diff_resid)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "black") +
  facet_grid(probe ~ exptCond) +
  labs(x = "ppm_diff | aprime_off",
       y = "aprime_diff | aprime_off",
       title = "added variable plot of ppm_diff") +
  theme_bw()
```

```{r minor-plot-aprime-ppm-coefplot}
aprime_by_ppm %>%
  mutate(model = map(model, ~broom::tidy(.))) %>%
  select(-data) %>%
  unnest(model) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       aprime_off_c = "A' OFF smoking",
                       ppm_diff = "ON - OFF change in CO ppm")) %>%
  ggplot(aes(x = estimate, y = fct_rev(term))) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_errorbarh(aes(xmin = estimate - 2*std.error, xmax = estimate + 2*std.error), height = 0) +
  geom_point() +
  facet_grid(probe ~ exptCond) +
  labs(x = "coefficient (unit effect on ON-OFF A' difference)",
       y = "model term",
       title = "model: A' diff ~ A' off (center = 0.5) + ppm diff (raw units)") +
  theme_bw()
```

## model fittin

As of 02/05/2020: Keep the original "onoff" model, and add one where the two-way interactions with `corResp` are allowed to vary by subject as well, then do all the model diagnosis stuff per usual

02/21/2020: re-fit the full_random model with effect-coded everything for more directly interpretable betas. Also, fit a manipulation check model predicting valid > invalid, but with no interactions, just main effects of the other ones

03/05/2020: Fit Paul's suggested model of `trial_type` with 8 dummy regressors for each combo of `probe` x `on_smoking` x `exptCond`, inspect as with all others

03/13/2020: Fit the Paul dummy model separately with 4 dummy regressors for art and room trials

03/18/2020: Fit the dummy model separately for each `exptCond * probe` condition

```{r, eval = FALSE}
models <- tibble(has_probe = c(rep(list(c("art", "room")), 3),
                               as.list(rep(c("art", "room"),
                                           times = 3))),
                  has_exptCond = c(rep(list(0:1), 3 + 2), as.list(rep(0:1, each = 2))),
                  has_valid = c(list(1L, 0:1),
                               as.list(rep(1L, 1 + 2 + 4))),
                  name = c("full", "manip_check", "dummy_all",
                           rep("dummy", 2),
                           rep("sep", 4))) %>%
  mutate(name = if_else(lengths(has_exptCond) == 1,
                        map2_chr(name, has_exptCond, ~.y %>%
                                   recode(`0` = "ctrl",
                                          `1` = "rel") %>%
                                   paste(.x, ., sep = "_", collapse = "_")),
                        name),
         name = if_else(lengths(has_probe) == 1,
                        map2_chr(name, has_probe, ~paste(.x, .y, sep = "_", collapse = "_")),
                        name),
         terms = case_when(name == "full" ~ list(c("corResp", "probe", "on_smoking", "exptCond")),
                           name == "manip_check" ~ list(c("corResp", "valid", "probe", "on_smoking", "exptCond")),
                           startsWith(name, "dummy") ~ list(c("corResp", "trial_type")),
                           startsWith(name, "sep") ~ list(c("corResp", "on_smoking")),
                           TRUE ~ list(NA)),
         ranefs = case_when(name == "full" ~ "(1 + (corResp + probe + exptCond + on_smoking)^2 | subj_num)",
                            name == "manip_check" ~ "(1 + corResp + valid + probe + exptCond + on_smoking | subj_num)",
                            startsWith(name, "dummy") ~ "(1 + corResp * trial_type | subj_num)",
                            startsWith(name, "sep") ~ "(1 + corResp * on_smoking | subj_num)",
                            TRUE ~ NA_character_),
         data = map(has_valid, ~raw %>% filter(valid %in% .x)),
         data = map2(data, has_probe, ~.x %>% filter(probe %in% .y)),
         data = map2(data, has_exptCond, ~.x %>% filter(exptCond %in% .y)),
         data = map(data, ~.x %>%
                      # EFFECT CODE TO THE HEAVENS!!!
                      mutate(
                        trial_type = case_when(
                          on_smoking == 0 & exptCond == 0 ~ "off_ctrl",
                          on_smoking == 0 & exptCond == 1 ~ "off_rel",
                          on_smoking == 1 & exptCond == 0 ~ "on_ctrl",
                          on_smoking == 1 & exptCond == 1 ~ "on_rel",
                          TRUE ~ NA_character_
                        ),
                        trial_type = paste(trial_type, probe, sep = "_"),
                        trial_type = fct_rev(trial_type),
                        resp_c = resp - 0.5,
                        corResp = corResp - 0.5,
                        exptCond = exptCond - 0.5,
                        probe = recode(probe,
                                       art = -0.5,
                                       room = 0.5),
                        on_smoking = on_smoking - 0.5,
                    log_rt = log(rt * 1000))),
         txt_formula = map_chr(terms, ~paste(.x, collapse = " + ")),
         txt_formula = case_when(
           name == "full" ~ paste0("(", txt_formula, ")^3"),
           name == "manip_check" ~ paste0("(", txt_formula, ")^3"),
           startsWith(name, "dummy") | startsWith(name, "sep") ~ paste0("(", txt_formula, ")^2")),
         txt_formula = paste("resp ~", txt_formula, "+", ranefs),
         # all the RT model setting stuff is here now
         terms_rt = map(terms, ~c("resp_c", .x)),
         txt_formula_rt = map_chr(terms_rt, ~paste(.x, collapse = " + ")),
         ranefs_rt = case_when(
           name == "full" ~ paste0("(1 + (", txt_formula_rt,")^3 | subj_num)"),
           name == "manip_check" ~ paste0("(1 + ", txt_formula_rt," | subj_num)"),
           startsWith(name, "dummy") | startsWith(name, "sep") ~ paste0("(1 + (", txt_formula_rt,")^2 | subj_num)"),
           TRUE ~ NA_character_
         ),
         txt_formula_rt = map_chr(terms_rt, ~paste(.x, collapse = " + ")),
         txt_formula_rt = case_when(
           name == "full" ~ paste0("(", txt_formula_rt, ")^3"),
           name == "manip_check" ~ paste0("(", txt_formula_rt, ")^3"),
           startsWith(name, "dummy") | startsWith(name, "sep") ~ paste0("(", txt_formula_rt, ")^3")),
         txt_formula_rt = paste("log_rt ~", txt_formula_rt, "+", ranefs_rt),
         init_r. = 1, # init_r. = if_else(name %in% c("full", "dummy_all"), 1, 2),
         iter. = if_else(startsWith(name, "sep"), 3000L, 2000L))

models %<>%
  mutate(model = pmap(list(txt_formula, data, init_r., iter.), 
                      function(a, b, c, d) {
                        rstanarm::stan_glmer(as.formula(a),
                                             family = binomial(link = "logit"),
                                             data = b,
                                             prior = rstanarm::cauchy(0, 2.5),
                                             prior_intercept = rstanarm::cauchy(0, 2.5),
                                             init_r = c,
                                             # MIGHT just need init_r = 1 for the dummy_all one...?
                                             # and then rel_room needs iter = 3000
                                             iter = d)
                      }))

models %<>%
  mutate(model_rt = pmap(list(txt_formula_rt, data, init_r., iter.), 
                      function(a, b, c, d) {
                        rstanarm::stan_glmer(as.formula(a),
                                             family = gaussian,
                                             data = b,
                                             prior = rstanarm::normal(0, 2.5),
                                             prior_intercept = rstanarm::normal(0, 10),
                                             init_r = c,
                                             # MIGHT just need init_r = 1 for the dummy_all one...?
                                             # and then rel_room needs iter = 3000
                                             iter = d)
                      }))


save(models, file = "ignore/data_R/models_rstanarm.rda")
```

```{r}
load("ignore/data_R/models_rstanarm.rda")
```

## results preppin

02/21/2020: Calculate a measure of model fit. predicted - actual RMSEs on hit/FA rates? Do this by re-drawing trials matching the original trial counts of the task?

```{r, eval = FALSE}
preplots_params <- models %>%
  select(name, iterations = model) %>%
  mutate(iterations = map(iterations, ~posterior_preplot_params(.x)))

preplots_bysubj <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select("subj_num", .y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_bysubj(.x, .y, pred_col = "resp_pred", type = "mean", draws = 400)),
         predicted = map_if(predicted, !startsWith(name, "dummy"),
                            ~.x %>%
                              mutate_at(vars(one_of("exptCond")), ~recode(.x, `-0.5` = "control", `0.5` = "relational")) %>%
                              mutate_at(vars(one_of("probe")), ~recode(.x, `-0.5` = "art", `0.5` = "room")) %>%
                              mutate(corResp = recode(corResp, `-0.5` = "fa", `0.5` = "hit"),
                                     on_smoking = recode(on_smoking, `-0.5` = "off", `0.5` = "on")),
                            .else = ~.x %>%
                              separate(trial_type,
                                       into = c("on_smoking", "exptCond", "probe")) %>%
                              mutate(corResp = recode(corResp, `-0.5` = "fa", `0.5` = "hit"),
                                     exptCond = recode(exptCond,
                                                       ctrl = "control",
                                                       rel = "relational"))),
         predicted = map(predicted, ~.x %>%
                           pivot_wider(names_from = corResp,
                                       values_from = resp_pred,
                                       names_prefix = "rate_") %>%
                           mutate(aprime = sdt_aprime(rate_hit, rate_fa)))) %>%
  select(name, predicted) %>%
  unnest(predicted) %>%
  mutate(deleteme = str_split(name, "_"),
         exptCond2 = map_chr(deleteme, ~if_else(length(.x) == 3, .x[2], .x[1])),
         exptCond2 = recode(exptCond2, rel = "relational", ctrl = "control"),
         probe2 = map_chr(deleteme, ~.x[length(.x)]),
         exptCond = coalesce(exptCond, exptCond2),
         probe = coalesce(probe, probe2),
         valid = coalesce(valid, 1L)) %>%
  select(-c(deleteme, exptCond2, probe2))

preplots_fixef <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select(.y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_fixef(.x, .y, pred_col = "resp_pred")),
         predicted = map_if(predicted, !startsWith(name, "dummy"),
                            ~.x %>%
                              mutate_at(vars(one_of("exptCond")), ~recode(.x, `-0.5` = "control", `0.5` = "relational")) %>%
                              mutate_at(vars(one_of("probe")), ~recode(.x, `-0.5` = "art", `0.5` = "room")) %>%
                              mutate(corResp = recode(corResp, `-0.5` = "fa", `0.5` = "hit"),
                                     on_smoking = recode(on_smoking, `-0.5` = "off", `0.5` = "on")),
                            .else = ~.x %>%
                              separate(trial_type,
                                       into = c("on_smoking", "exptCond", "probe")) %>%
                              mutate(corResp = recode(corResp, `-0.5` = "fa", `0.5` = "hit"),
                                     exptCond = recode(exptCond,
                                                       ctrl = "control",
                                                       rel = "relational"))),
         predicted = map(predicted, ~.x %>%
                           pivot_wider(names_from = corResp,
                                       values_from = resp_pred,
                                       names_prefix = "rate_") %>%
                           mutate(aprime = sdt_aprime(rate_hit, rate_fa)))) %>%
  select(name, predicted) %>%
  unnest(predicted) %>%
  mutate(deleteme = str_split(name, "_"),
         exptCond2 = map_chr(deleteme, ~if_else(length(.x) == 3, .x[2], .x[1])),
         exptCond2 = recode(exptCond2, rel = "relational", ctrl = "control"),
         probe2 = map_chr(deleteme, ~.x[length(.x)]),
         exptCond = coalesce(exptCond, exptCond2),
         probe = coalesce(probe, probe2),
         valid = coalesce(valid, 1L)) %>%
  select(-c(deleteme, exptCond2, probe2))

preplots_raw_bysubj <- preplots_bysubj %>%
  filter(name != "manip_check") %>%
  mutate(name = recode(name,
                       full = "2x2x2",
                       dummy_art = "dummy_byprobe",
                       dummy_room = "dummy_byprobe"),
         name = if_else(startsWith(name, "sep"), "sep", name),
         name = paste0("model_", name)) %>%
  bind_rows(sdt_metrics %>%
              select(subj_num, on_smoking, exptCond, probe = cue, rate_fa, rate_hit, aprime) %>%
              mutate(name = "raw"))

preplots_raw_fixef <- preplots_fixef %>%
  filter(name != "manip_check") %>%
  mutate(name = recode(name,
                       dummy_art = "dummy_byprobe",
                       dummy_room = "dummy_byprobe"),
         name = if_else(startsWith(name, "sep"), "sep", name)) %>%
  arrange(name, iteration, probe, exptCond, on_smoking) %>%
  group_by(name, iteration, probe, exptCond) %>%
  summarize(diff_rate_fa = diff(rate_fa),
            diff_rate_hit = diff(rate_hit),
            diff_aprime = diff(aprime)) %>%
  pivot_longer(starts_with("diff"), names_to = "metric_type", values_to = "diff_smoking", names_prefix = "diff_") %>%
  nest(diffs = -c(name, probe, exptCond, metric_type)) %>%
  mutate(diff_smoking_q025 = map_dbl(diffs, ~quantile(.x$diff_smoking, .025)),
         diff_smoking_q50 = map_dbl(diffs, ~median(.x$diff_smoking)),
         diff_smoking_q975 = map_dbl(diffs, ~quantile(.x$diff_smoking, .975))) %>%
  left_join(sdt_metrics %>%
              rename(probe = cue) %>%
              arrange(subj_num, probe, exptCond, on_smoking) %>%
              group_by(subj_num, probe, exptCond) %>%
              summarize(diff_rate_fa = diff(rate_fa),
                        diff_rate_hit = diff(rate_hit),
                        diff_aprime = diff(aprime)) %>%
              ungroup() %>%
              pivot_longer(starts_with("diff"), names_to = "metric_type", values_to = "diff_smoking", names_prefix = "diff_") %>%
              group_by(probe, exptCond, metric_type) %>%
              summarize(raw_median_diff_smoking = median(diff_smoking),
                        raw_mean_diff_smoking = mean(diff_smoking)),
            by = c("probe", "exptCond", "metric_type"))

save(preplots_params, preplots_bysubj, preplots_fixef, preplots_raw_bysubj, preplots_raw_fixef, file = "ignore/data_R/preplots_rstanarm.rda")
```

```{r, eval = FALSE}
preplots_rt_params <- models %>%
  select(name, iterations = model_rt) %>%
  mutate(iterations = map(iterations, ~posterior_preplot_params(.x)))

preplots_rt_fixef <- models %>%
  select(name, terms_rt, data, model_rt) %>%
  rename(terms = terms_rt, model = model_rt) %>%
  mutate(data = map2(data, terms, ~.x %>% select(.y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_fixef(.x, .y, pred_col = "log_rt_pred")),   
         predicted = map_if(predicted, !startsWith(name, "dummy"),
                            ~.x %>%
                              mutate_at(vars(one_of("exptCond")), ~recode(.x, `-0.5` = "control", `0.5` = "relational")) %>%
                              mutate_at(vars(one_of("probe")), ~recode(.x, `-0.5` = "art", `0.5` = "room")) %>%
                              mutate(resp = recode(resp_c, `-0.5` = "no_match", `0.5` = "match"),
                                     corResp = recode(corResp, `-0.5` = "no_match", `0.5` = "match"),
                                     on_smoking = recode(on_smoking, `-0.5` = "off", `0.5` = "on")),
                            .else = ~.x %>%
                              separate(trial_type,
                                       into = c("on_smoking", "exptCond", "probe")) %>%
                              mutate(resp = recode(resp_c, `-0.5` = "no_match", `0.5` = "match"),
                                     corResp = recode(corResp, `-0.5` = "fa", `0.5` = "hit"),
                                     exptCond = recode(exptCond,
                                                       ctrl = "control",
                                                       rel = "relational")))) %>%
  select(name, predicted) %>%
  unnest(predicted) %>%
  mutate(deleteme = str_split(name, "_"),
         exptCond2 = map_chr(deleteme, ~if_else(length(.x) == 3, .x[2], .x[1])),
         exptCond2 = recode(exptCond2, rel = "relational", ctrl = "control"),
         probe2 = map_chr(deleteme, ~.x[length(.x)]),
         exptCond = coalesce(exptCond, exptCond2),
         probe = coalesce(probe, probe2),
         valid = coalesce(valid, 1L),
         acc = case_when(resp == "match" & corResp == "match" ~ "hit",
                         resp == "no_match" & corResp == "match" ~ "miss",
                         resp == "match" & corResp == "no_match" ~ "fa",
                         resp == "no_match" & corResp == "no_match" ~ "cr",
                         TRUE ~ NA_character_),
         rt_pred = exp(log_rt_pred)) %>%
  select(-c(deleteme, exptCond2, probe2, resp_c))

save(preplots_rt_params, preplots_rt_fixef, file = "ignore/data_R/preplots_rt_rstanarm.rda")
```


```{r}
load("ignore/data_R/preplots_rstanarm.rda")
load("ignore/data_R/preplots_rt_rstanarm.rda")
```

## results graphin

### parameter estimates

Parameter estimates from model 1 and model 2, where both control and relational trials are included and `exptCond` is used as a predictor to look at interactions of d' and all conditions. Model 1 fixes all interaction effects, and only has a random effect of intercept and `corResp` (overall d'), while model 2 allows all second-order interactions to vary by subject as well.

03/18/2020:

- **minor plot**: coefplot from 2x2x2 model
- **minor result**: Report valid > invalid A' from `manip_check`
- **major result**: describe various ctrl/rel room/art things
- **major result**: describe on/off smoking differences
- **minor result**: describe converging results from alternate model fits

```{r}
plot_params <- function (df, model_name) {
  df %>%
    filter(startsWith(name, model_name)) %>%
    unnest(iterations) %>%
    ggplot(aes(x = estimate, fill = name)) +
    geom_histogram(position = "identity", alpha = 0.4) +
    geom_vline(xintercept = 0, linetype = 3, color = "purple") +
    geom_vline(aes(xintercept = estimate, color = name),
               data = df %>%
                 filter(startsWith(name, model_name)) %>%
                 unnest(iterations) %>%
                 group_by(name, term) %>%
                 summarize(estimate = median(estimate)),
               linetype = 3) +
    facet_wrap(~ term, scales = "free") +
    labs(title = glue::glue("visual coefficients/SEs for model(s): {model_name}"))
}

preplots_params %>%
  plot_params("full")
```

Based on at least the parameter estimates of the fixed effects, it looks like the model with the random effects isn't drastically different in median estimates of most of the fixed effects. Sure the standard errors are bigger, but I think I'm ok with this. As you'll see below, allowing more random effects reduces the effective regularization of single subject d', leaving more variability in place. I think we want this!


```{r}
preplots_params %>%
  plot_params("manip_check")
```

```{r}
preplots_params %>%
  plot_params("dummy")
```

```{r}
preplots_params %>%
  plot_params("sep_rel_room")
```

### assessing model fit

#### comparing raw 'aprime' to the models

Plotting the condition-wise A' estimated from subjects' raw hit and FA rates as well as their model-estimated hit and FA rates. Here you can see much more clearly that both models (few random effects and all second-order random effects) serve to regularize condition-wise A' values that differ very much from that subject's other condition-wise A' values. The sparser model is regularizing much more heavily than the fuller model with second-order random effects.

```{r}
preplots_raw_bysubj %>%
  ggplot(aes(x = interaction(on_smoking, exptCond, probe), y = aprime, color = name)) +
  geom_line(aes(group = name)) +
  geom_point(size = 0.5) +
  labs(x = "every sub-condition",
       y = "A'",
       title = "Raw and model-estimated A' by condition by subject",
       subtitle = "The models regularize, adding random effects regularizes less") +
  facet_wrap(~subj_num) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

In general, I'm not too worried about discrepancies between the model-fit data and the raw data, because this shows that the random-effects model is doing a pretty good job of retaining condition-level performance that's lower, but regularizing it up a bit higher.

```{r}
preplots_raw_bysubj %>%
  select(-valid) %>%
  nest(data = -name) %>%
  mutate(raw = data[name == "raw"]) %>%
  filter(name != "raw") %>%
  mutate(data = map2(data, raw,
                     ~full_join(.x, .y, by = c("subj_num", "on_smoking", "exptCond", "probe"), suffix = c("_model", "_raw")))) %>%
  select(-raw) %>%
  unnest(data) %>%
  pivot_longer(cols = c(ends_with("model"), ends_with("raw")), names_to = c("metric_type", ".value"), names_pattern = "(.*)_(.*)") %>%
  mutate(error = model - raw) %>%
  group_by(name, metric_type, on_smoking, exptCond, probe) %>%
  summarize(rmse = sqrt(mean(error ^ 2)),
            mae = median(abs(error))) %>%
  pivot_longer(cols = c(rmse, mae), names_to = "error_type", values_to = "error") %>%
  ggplot(aes(x = error_type, y = error, fill = name)) +
  geom_hline(yintercept = 0, linetype = 3) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.6) +
  facet_grid(metric_type ~ on_smoking + exptCond + probe)
```


### Plotting predicted d' and stuff

#### Reproducing Nick's plots (ish), with model on top

You'll go on to see that the predicted effects map well on to raw-derived _mean_ values for A', hit rate, and false alarm rate. When the plots are rendered with raw-derived _median_ values, the between-condition slopes are a little steeper, but maybe not in an interesting way.

03/18/2020: **major plot**: Do the Nick's plot of A' with on smoking on the right, only the dots and spaghetti from the raw data, and only the fat model fit line from the 2x2x2 model

```{r}
preplots_raw_bysubj %>%
  mutate(on_smoking = fct_rev(on_smoking)) %>%
  ggplot(aes(x = on_smoking, y = aprime, color = name)) +
  geom_line(aes(group = interaction(subj_num, name)), alpha = 0.1) +
  geom_jitter(width = 0.1, alpha = 0.2) +
  geom_line(aes(group = name),
            data = preplots_raw_bysubj %>%
              mutate(on_smoking = fct_rev(on_smoking)) %>%
              group_by(name, on_smoking, exptCond, probe) %>%
              summarize(aprime = median(aprime)),
            size = 1.5,
            alpha = 0.8) +
  geom_hline(yintercept = 0.5, linetype = 3) +
  labs(title = "cholinergic modulation of A' by all the conditions") +
  facet_grid( ~ exptCond + probe)
```

```{r}
preplots_raw_bysubj %>%
  select(-aprime) %>%
  pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
  mutate(on_smoking = fct_rev(on_smoking),
         rate_type = fct_rev(rate_type)) %>%
  ggplot(aes(x = on_smoking, y = rate, color = name)) +
  geom_line(aes(group = interaction(subj_num, name)), alpha = 0.1) +
  geom_line(aes(group = name),
            data = preplots_raw_bysubj %>%
              select(-aprime) %>%
              pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
              mutate(on_smoking = fct_rev(on_smoking),
                     rate_type = fct_rev(rate_type)) %>%
              group_by(name, on_smoking, probe, exptCond, rate_type) %>%
              summarize(rate = mean(rate)),
            size = 1) +
  geom_jitter(width = 0.1, alpha = 0.2) +
  labs(title = "cholinergic modulation of hit/FA rate by all the conditions") +
  facet_grid(rate_type ~ exptCond + probe)
```

#### fixed effects over everyone

The most important thing to do here will be to generate posterior distributions of test statistics of interest, now that all the overall effect visualization can be done on the by-subject predictions.

As far as I understand it, the key test statistics all depend on _the difference between the on-smoking and off-smoking conditions._

Accordingly, the preplot object being used here has `diff_smoking` calculated over iterations as a default.

```{r}
preplots_raw_fixef %>%
  mutate(metric_type = recode(metric_type,
                              aprime = "A'",
                              rate_fa = "false alarm rate",
                              rate_hit = "hit rate")) %>%
  select(-starts_with("diff_")) %>%
  unnest(diffs) %>%
  ggplot(aes(x = exptCond, y = diff_smoking, fill = probe, color = probe)) +
  geom_hline(yintercept = 0, linetype = 3) +
  geom_violin(position = "identity", draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.2) +
  geom_point(aes(y = raw_mean_diff_smoking),
             data = preplots_raw_fixef %>%
                 mutate(metric_type = recode(metric_type,
                              aprime = "A'",
                              rate_fa = "false alarm rate",
                              rate_hit = "hit rate")),
             size = 3) +
  # scale_color_manual(values = c("springgreen1", "mediumorchid1", "springgreen4", "mediumorchid4")) +
  # scale_fill_manual(values = c("springgreen1", "mediumorchid1", "springgreen4", "mediumorchid4")) +
  labs(x = "control or relational?",
       y = "ON - OFF smoking difference",
       title = "on-off smoking diffs by condition",
       subtitle = "Big dots: across-subject MEANS from raw data") +
  facet_grid(metric_type ~ name)
```

```{r}
preplots_fixef %>%
  filter(!(name %in% c("manip_check", "rel_room"))) %>%
  unnest(predicted) %>%
  pivot_longer(c(aprime, rate_hit, rate_fa), names_to = "metric_type", values_to = "value") %>%
  arrange(name, metric_type, iteration, probe, exptCond, on_smoking) %>%
  group_by(name, metric_type, iteration, exptCond, on_smoking) %>%
  summarize(diff_probe = diff(value)) %>%
  ggplot(aes(x = on_smoking, y = diff_probe, fill = exptCond, color = exptCond)) +
  geom_hline(yintercept = 0, linetype = 3) +
  geom_violin(position = "identity", draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.2) +
  geom_point(data = sdt_metrics %>%
               select(subj_num, on_smoking, exptCond, probe = cue, rate_fa, rate_hit, aprime) %>%
               pivot_longer(c(rate_fa, rate_hit, aprime), names_to = "metric_type", values_to = "value") %>%
               arrange(subj_num, metric_type, exptCond, on_smoking) %>%
               group_by(subj_num, metric_type, exptCond, on_smoking) %>%
               summarize(diff_probe = diff(value)) %>%
               group_by(metric_type, exptCond, on_smoking) %>%
               summarize(diff_probe = median(diff_probe)),
             size = 3) +
  labs(x = "on or off smoking?",
       y = "ROOM - ART difference",
       title = "room/art performance diffs by condition",
       subtitle = "Big dots: across-subject MEDIANS from raw data") +
  facet_grid(metric_type ~ name, scales = "free_y")
```


### plotting test statistics

02/14/2020: Plot the betas concerning `corResp` in A'/hit/FA rate space for all of the relevant interactions to characterize what they mean. Or something.

03/27/2020: Test again for a difference in on-off slope between relational art and relational room in the `dummy_all` model

```{r}
var = "aprime"
sym_var = sym(var)

preplots_fixef %>%
  filter(name != "manip_check") %>%
  ggplot(aes(x = on_smoking, y = {{sym_var}}, color = interaction(exptCond, probe))) +
  geom_line(aes(group = interaction(iteration, exptCond, probe)), alpha = 0.01) +
  geom_line(aes(group = interaction(exptCond, probe)),
            data = preplots_fixef %>%
              filter(name != "manip_check") %>%
              group_by(name, on_smoking, probe, exptCond) %>%
              summarize(!!var := median({{sym_var}}))) +
  geom_line(aes(group = interaction(exptCond, probe)),
            data = sdt_metrics %>%
              rename(probe = cue) %>%
              group_by(on_smoking, exptCond, probe) %>%
              summarize(!!var := mean({{sym_var}})),
            linetype = 3,
            size = 1) +
  lims(y = 0:1) +
  scale_color_manual(values = c("deeppink1", "deepskyblue1", "deeppink4", "deepskyblue4")) +
  facet_grid(~ name)
```


Searching for the following difference from the descriptive-only statistics:

relational trials: FA_on < FA_off for room, FA_on == FA_off for art

control trials: no such differences?

```{r}
preplots_raw_fixef %>%
  select(name, probe, exptCond, metric_type, diffs) %>%
  unnest(diffs) %>%
  arrange(name, metric_type, iteration, probe, exptCond) %>%
  group_by(name, metric_type, iteration, probe) %>%
  summarize(diff_smoking_exptCond = diff(diff_smoking)) %>%
  ggplot(aes(x = diff_smoking_exptCond, fill = probe)) +
  geom_density(position = "identity", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = 3) +
  facet_grid(name ~ metric_type, scales = "free_x")
```


02/21/2020: focus in on interaction between on-off/art-room/ctrl-relational. Is the diff between on-off room relational - on-off art relational DIFFERENT than the diff between on-off room control - on-off art control. And is the former different from 0?

Neither on-off room - on-off art difference is on average very far from 0.

```{r}
preplots_raw_fixef %>%
  select(name, probe, exptCond, metric_type, diffs) %>%
  unnest(diffs) %>%
  arrange(name, metric_type, iteration, probe, exptCond) %>%
  group_by(name, metric_type, iteration, exptCond) %>%
  summarize(diff_smoking_probe = diff(diff_smoking)) %>%
  ggplot(aes(x = diff_smoking_probe, fill = exptCond)) +
  geom_density(position = "identity", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = 3) +
  facet_grid(name ~ metric_type, scales = "free_x")
```

(on-off room - on-off art RELATIONAL) - (on-off room - on-off art CONTROL) generally centered on 0. More positive would mean the relational one is higher than the control one.

```{r}
preplots_raw_fixef %>%
  select(name, probe, exptCond, metric_type, diffs) %>%
  unnest(diffs) %>%
  arrange(name, metric_type, iteration, probe, exptCond) %>%
  group_by(name, metric_type, iteration, exptCond) %>%
  summarize(diff_smoking_probe = diff(diff_smoking)) %>%
  group_by(name, metric_type, iteration) %>%
  summarize(diff_smoking_probe_exptCond = diff(diff_smoking_probe)) %>%
  ggplot(aes(x = diff_smoking_probe_exptCond)) +
  geom_density(position = "identity", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = 3) +
  facet_grid(name ~ metric_type, scales = "free_x")
```

### rt analyses

```{r}
preplots_rt_fixef %>%
  filter(name == "full") %>%
  nest(data = -iteration) %>%
  sample_n(300) %>%
  unnest(data) %>%
  ggplot(aes(x = on_smoking, y = exp(log_rt_pred), fill = acc)) +
  geom_violin(position = "identity", alpha = 0.2, draw_quantiles = c(.025, .975)) +
  facet_grid(~ exptCond + probe)
```

## a simulation analysis?

