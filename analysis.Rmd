---
title: "multilevel smokers art gallery analyses"
author: "Monica Thieu"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(magrittr)
require(rlang)
options(mc.cores = parallel::detectCores())

snodgrass <- function (num, denom) return((num+.5)/(denom+1))
snodgrass_vec <- function (vec) return((sum(vec) + 0.5) / (length(x) + 1))
sdt_pr <- function (hit, fa) return(hit - fa)
sdt_br <- function(hit, fa) return(fa / (1 - (hit - fa)))
sdt_aprime <- function (hit, fa) return(.5 + (sign(hit-fa)*((hit-fa)^2 + abs(hit-fa))/(4*pmax(hit,fa)-(4*hit*fa))))
sdt_b2prime <- function (hit, fa)  return(sign(hit-fa)*(hit*(1-hit) - fa*(1-fa))/(hit*(1-hit) + fa*(1-fa)))
sdt_dprime <- function (hit, fa) return(qnorm(hit) - qnorm(fa))
sdt_c <- function (hit, fa) return(-.5 * (qnorm(hit) + qnorm(fa)))

posterior_preplot_params <- function (object) {
  out <- object %>%
    as.data.frame() %>%
    as_tibble() %>%
    mutate(iteration = 1:nrow(.)) %>%
    # removes all random effects and sigma terms. should yield fixed effects only
    select(-contains("["), -contains("sigma")) %>%
    rename(intercept = "(Intercept)") %>%
    pivot_longer(cols = -iteration, names_to = "term", values_to = "estimate")
  
  return (out)
}

posterior_preplot_bysubj <- function (object, newdata, pred_col = "y_pred", draws = 1000) {
  out <- object %>%
    rstanarm::posterior_linpred(transform = TRUE,
                                newdata = newdata,
                                re.form = NULL,
                                draws = draws)

  # Just the median of every predicted point for every subject
  # Note that this doesn't select in a paired way for the "median iteration"
  # returns a VECTOR which needs to get slapped onto newdata
  out %<>%
    apply(2, median) %>%
    t() %>%
    c()
  
  newdata %<>%
    mutate(!!pred_col := out)
  
  return (newdata)
}

posterior_preplot_fixef <- function (object, newdata, pred_col = "y_pred", draws = 1000) {
  
  out <- object %>%
    rstanarm::posterior_linpred(transform = TRUE,
                                newdata = newdata,
                                re.form = NA,
                                draws = draws)
  
  newdata %<>%
    # Must expand AFTER predictions is already done to repeat for iterations
    # need the "obs" column to make damn sure that the correct predicted points get pasted on the correct x values
    mutate(obs = 1:nrow(.),
           iteration = map(obs, ~1:draws)) %>%
    unchop(iteration)
  
  out %<>%
    as_tibble() %>%
    mutate(iteration = 1:nrow(.)) %>%
    pivot_longer(cols = -iteration, names_to = "obs", values_to = pred_col) %>%
    mutate(obs = as.integer(obs)) %>%
    right_join(newdata, by = c("obs", "iteration")) %>%
    # the obs column obstructs any later pivoting, and is technically redundant if all the x cols are in there,
    # so get outta here
    select(-obs)
  
  return(out)
}

demos = read_csv("ignore/demographics/demo_smoke_habits.csv") %>%
  mutate(cigs_per_day_est = 10 * cigs_per_day_est) %>%
  mutate_if(is.numeric, as.integer) %>%
  mutate(cigs_per_day_est = .1 * cigs_per_day_est,
         ppm_on = if_else(condition == 1, ppm_s1, ppm_s2),
         ppm_off = if_else(condition == 1, ppm_s2, ppm_s1))

raw = tibble(filename = list.files("ignore/data_raw", pattern = ".txt", full.names = TRUE)) %>%
  mutate(data = map(filename, ~.x %>%
                      read_delim(delim = "\t",
                                 skip = 9,
                                 col_names = FALSE) %>%
                      select(trial = X1,
                             stimOnsetTime = X2,
                             exptCond = X4,
                             stimNum = X6,
                             cue = X7,
                             probe = X8,
                             valid = X9,
                             resp = X10,
                             corResp = X11,
                             acc = X12,
                             rt = X13) %>%
                      mutate_at(c("trial", "exptCond", "valid", "resp", "corResp", "acc"),
                                as.integer) %>%
                    mutate_at(c("cue", "probe"), ~recode(., `1` = "art", `2` = "room")))) %>%
  mutate(subj_num = as.integer(str_sub(filename, start = 32L, end = 34L)),
         session_num = str_sub(filename, start = -5L, end = -5L),
         session_num = if_else(session_num == "2", 2L, 1L)) %>%
  select(-filename) %>%
  left_join(demos %>%
              select(subj_num, condition, ppm_on, ppm_off) %>%
              pivot_longer(names_to = "on_smoking", values_to = "ppm", cols = starts_with("ppm")) %>% 
              mutate(on_smoking = recode(on_smoking, ppm_on = 1L, ppm_off = 0L),
                     ppm_z = c(scale(ppm))),
            by = "subj_num") %>%
  # Scrub all subjects who don't appear in demographics data
  filter(!is.na(condition)) %>%
  mutate(on_smoking = as.integer(session_num == condition)) %>%
  unnest(data)
```

## checking data quality

```{r}
# Should be 0 length
raw %>%
  count(subj_num, on_smoking) %>%
  filter(n < 80)
```

For eyeballing:

```{r}
raw %>%
  group_by(subj_num, on_smoking, corResp) %>%
  summarize(mean_acc = mean(acc)) %>%
  pivot_wider(names_from = corResp, values_from = mean_acc, names_prefix = "rate_") %>%
  rename(rate_cr = rate_0, rate_hit = rate_1) %>%
  mutate(rate_fa = 1 - rate_cr) %>%
  ggplot(aes(x = rate_hit, y = rate_fa, color = factor(on_smoking))) +
  geom_point()
```

## Purely descriptive statistix

Pretty sure most of these hinge on manually calculating A'/d' and such.

```{r}
sdt_metrics <- raw %>%
  filter(valid == 1) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on")) %>%
  group_by(subj_num, on_smoking, exptCond, cue, corResp) %>%
  summarize(rate = mean(resp), snod = snodgrass_vec(resp), n_trials = n()) %>%
  pivot_wider(names_from = corResp, values_from = c(rate, snod)) %>%
  mutate(aprime = sdt_aprime(rate_hit, rate_fa),
         dprime = sdt_dprime(snod_hit, snod_fa))

sdt_metrics %>%
  ggplot(aes(x = exptCond, y = aprime, color = cue)) +
  geom_line(aes(group =interaction(subj_num, cue)), alpha = 0.5) +
  geom_point() +
  facet_grid(~ on_smoking)
```

Attempting to recreate the original "significant" statistic from Nick's descriptive analysis

```{r}
sdt_metrics %>%
  ungroup() %>%
  select(-starts_with("rate")) %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  pivot_wider(names_from = exptCond, values_from = aprime, names_prefix = "aprime_") %>%
  mutate(aprime_diff_rel = aprime_relational - aprime_control) %>%
  ggplot(aes(x = on_smoking, y = aprime_diff_rel, color = cue)) +
  geom_line(aes(group = interaction(subj_num, cue)), alpha = 0.5) +
  geom_line(aes(group = cue),
            data = sdt_metrics %>%
              ungroup() %>%
              select(-starts_with("rate")) %>%
              mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
              pivot_wider(names_from = exptCond, values_from = aprime, names_prefix = "aprime_") %>%
              mutate(aprime_diff_rel = aprime_relational - aprime_control) %>%
              group_by(on_smoking, cue) %>%
              summarize(aprime_diff_rel = median(aprime_diff_rel)),
            size = 1) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = 3) +
  facet_grid(~ cue)
```


## model fittin

As of 02/05/2020: Keep the original "onoff" model, and add one where the two-way interactions with `corResp` are allowed to vary by subject as well, then do all the model diagnosis stuff per usual

```{r, eval = FALSE}
models2 <- tibble(name = c("full", "full_random", "control", "relational"),
                 has_exptCond = list(0:1, 0:1, 0L, 1L)) %>%
  mutate(data = map(has_exptCond, ~raw %>%
                      filter(valid == 1, exptCond %in% .x)),
         terms = map(1:n(), ~c("corResp", "probe", "on_smoking")),
         terms = map_if(terms, lengths(has_exptCond) > 1,
                        ~c(.x, "exptCond"),
                        .else = ~.x),
         ranefs = if_else(name == "full_random",
                          "(1 + (corResp + probe + exptCond + on_smoking)^2 - probe:exptCond - probe:on_smoking - exptCond:on_smoking | subj_num)",
                          "(1 + corResp | subj_num)"),
         txt_formula = map_chr(terms, ~paste(.x, collapse = " + ")),
         txt_formula = paste0("resp ~ (", txt_formula, ")^3 + (1 + corResp | subj_num)"),
         model = map2(txt_formula, data, ~rstanarm::stan_glmer(as.formula(.x),
                                                               family = binomial(link = "logit"),
                                                               data = .y,
                                                               prior = rstanarm::cauchy(0, 5),
                                                               prior_intercept = rstanarm::cauchy(0, 5))))

save(models, file = "ignore/data_R/models_rstanarm.rda")
```

```{r}
load("ignore/data_R/models_rstanarm.rda")
```

## results preppin

```{r}
preplots_params <- models %>%
  select(name, iterations = model) %>%
  mutate(iterations = map(iterations, ~posterior_preplot_params(.x)))
```

```{r}
preplots_bysubj <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select("subj_num", .y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_bysubj(.x, .y, pred_col = "resp_pred")),
         predicted = map(predicted, ~.x %>%
                            mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit")) %>%
                            pivot_wider(names_from = corResp,
                                        values_from = resp_pred,
                                        names_prefix = "rate_") %>%
                            mutate(dprime = qnorm(rate_hit) - qnorm(rate_fa)))) %>%
  select(name, predicted)
```

```{r}
preplots_fixef <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select(.y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_fixef(.x, .y, pred_col = "resp_pred")),
         predicted = map(predicted, ~.x %>%
                           mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit")) %>%
                           pivot_wider(names_from = corResp,
                                       values_from = resp_pred,
                                       names_prefix = "rate_") %>%
                           mutate(dprime = qnorm(rate_hit) - qnorm(rate_fa)))) %>%
  select(name, predicted)
```

## results graphin

### parameter estimates

Just parameter estimates from model 1, where both control and relational trials are included and `exptCond` is used as a predictor to look at interactions of d' and allllll conditions.

```{r}
preplots_params$iterations[[1]] %>%
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_vline(aes(xintercept = estimate),
             data = preplots_params$iterations[[1]] %>%
               group_by(term) %>%
               summarize(estimate = median(estimate)),
             color = "hotpink",
             linetype = 3) +
  facet_wrap(~ term, scales = "free")
```

Comparing the relational only binary smoking model and relational only ppm model. The ppm model basically appears to be a drastically less stable version of the binary smoking model.

```{r}
preplots_params %>%
  filter(name %in% c("ppm", "relational")) %>%
  unnest(iterations) %>%
  mutate(term = if_else(name == "ppm",
                        str_replace(term, "ppm_z", "smoking"),
                        str_replace(term, "on_smoking", "smoking"))) %>%
  ggplot(aes(x = estimate)) +
  geom_histogram(aes(fill = name), position = "identity", alpha = 0.4) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_vline(aes(xintercept = estimate, color = name),
             data = preplots_params %>%
               filter(name %in% c("ppm", "relational")) %>%
               unnest(iterations) %>%
               mutate(term = if_else(name == "ppm",
                                     str_replace(term, "ppm_z", "smoking"),
                                     str_replace(term, "on_smoking", "smoking"))) %>%
               group_by(name, term) %>%
               summarize(estimate = median(estimate)),
             linetype = 3) +
  facet_wrap(~ term, scales = "free")
```

### Plotting predicted d' and stuff

#### by subject

```{r}
preplots_bysubj$predicted[[1]] %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  ggplot(aes(x = on_smoking, y = dprime, color = probe)) +
  geom_line(aes(group = interaction(subj_num, probe))) +
  geom_point() +
  facet_grid(probe ~ exptCond)
```

```{r}
preplots_bysubj$predicted[[1]] %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  ggplot(aes(x = on_smoking, y = rate_hit, color = probe)) +
  geom_line(aes(group = interaction(subj_num, probe))) +
  geom_point() +
  facet_grid(~exptCond)
```

```{r}
preplots_bysubj %>%
  filter(name != "ppm") %>%
  unnest(predicted) %>%
  mutate(exptCond = case_when(name == "control" ~ 0L,
                              name == "relational" ~ 1L,
                              TRUE ~ exptCond),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  ggplot(aes(x = interaction(probe, on_smoking, exptCond), y = dprime, color = name)) +
  geom_line(aes(group = name)) +
  geom_point() +
  facet_wrap(~subj_num) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

#### fixed effects over everyone

```{r}
preplots_fixef$predicted[[1]] %>%
  mutate(exptCond = recode(exptCond, `0` = "control", `1` = "relational"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on")) %>%
  ggplot(aes(x = probe, y = dprime, color = exptCond, fill = exptCond)) +
  geom_jitter(alpha = 0.1) +
  geom_violin(position = "identity", alpha = 0.5) +
  facet_grid(~ on_smoking)
```

```{r}
preplots_fixef$predicted[[1]] %>%
  select(-obs) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit")) %>%
  pivot_wider(names_from = corResp, values_from = resp_pred, names_prefix = "rate_") %>%
  mutate(dprime = qnorm(rate_hit) - qnorm(rate_fa)) %>%
  ggplot(aes(x = probe, y = dprime, color = factor(exptCond))) +
  geom_jitter(alpha = 0.3) +
  facet_grid(~ on_smoking)
```
