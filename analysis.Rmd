---
title: "multilevel smokers art gallery analyses"
author: "Monica Thieu"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(magrittr)
options(mc.cores = parallel::detectCores())

demos = read_csv("ignore/demographics/demo_smoke_habits.csv") %>%
  mutate(cigs_per_day_est = 10 * cigs_per_day_est) %>%
  mutate_if(is.numeric, as.integer) %>%
  mutate(cigs_per_day_est = .1 * cigs_per_day_est,
         ppm_on = if_else(condition == 1, ppm_s1, ppm_s2),
         ppm_off = if_else(condition == 1, ppm_s2, ppm_s1))

raw = tibble(filename = list.files("ignore/data_raw", pattern = ".txt", full.names = TRUE)) %>%
  mutate(data = map(filename, ~.x %>%
                      read_delim(delim = "\t",
                                 skip = 9,
                                 col_names = FALSE) %>%
                      select(trial = X1,
                             stimOnsetTime = X2,
                             exptCond = X4,
                             stimNum = X6,
                             cue = X7,
                             probe = X8,
                             valid = X9,
                             resp = X10,
                             corResp = X11,
                             acc = X12,
                             rt = X13) %>%
                      mutate_at(c("trial", "exptCond", "valid", "resp", "corResp", "acc"),
                                as.integer) %>%
                    mutate_at(c("cue", "probe"), ~recode(., `1` = "art", `2` = "room")))) %>%
  mutate(subj_num = as.integer(str_sub(filename, start = 32L, end = 34L)),
         session_num = str_sub(filename, start = -5L, end = -5L),
         session_num = if_else(session_num == "2", 2L, 1L)) %>%
  select(-filename) %>%
  left_join(demos %>%
              select(subj_num, condition, ppm_on, ppm_off) %>%
              pivot_longer(names_to = "on_smoking", values_to = "ppm", cols = starts_with("ppm")) %>% 
              mutate(on_smoking = recode(on_smoking, ppm_on = 1L, ppm_off = 0L)),
            by = "subj_num") %>%
  # Scrub all subjects who don't appear in demographics data
  filter(!is.na(condition)) %>%
  mutate(on_smoking = as.integer(session_num == condition)) %>%
  unnest(data)
```

## checking data quality

```{r}
# Should be 0 length
raw %>%
  count(subj_num, on_smoking) %>%
  filter(n < 80)
```

For eyeballing:

```{r}
raw %>%
  group_by(subj_num, on_smoking, corResp) %>%
  summarize(mean_acc = mean(acc)) %>%
  pivot_wider(names_from = corResp, values_from = mean_acc, names_prefix = "rate_") %>%
  rename(rate_cr = rate_0, rate_hit = rate_1) %>%
  mutate(rate_fa = 1 - rate_cr) %>%
  ggplot(aes(x = rate_hit, y = rate_fa, color = factor(on_smoking))) +
  geom_point()
```



## results baby

```{r}
model <- lme4::glmer(resp ~ corResp * probe * on_smoking + (1 + corResp | subj_num),
                     data = raw %>% filter(valid == 1),
                     family = binomial(link = "logit"))
```

```{r}
summary(model)
```

```{r, eval = FALSE}
model_onoff_rstanarm <- rstanarm::stan_glmer(resp ~ corResp * probe * on_smoking + (1 + corResp | subj_num),
                                       family = binomial(link = "logit"),
                                       data = raw %>% filter(valid == 1, exptCond == 1),
                                       prior = rstanarm::cauchy(0, 5),
                                       prior_intercept = rstanarm::cauchy(0, 5))

model_ppm_rstanarm <- rstanarm::stan_glmer(resp ~ corResp * probe * scale(ppm) + (1 + corResp | subj_num),
                                       family = binomial(link = "logit"),
                                       data = raw %>% filter(valid == 1, exptCond == 1),
                                       prior = rstanarm::cauchy(0, 5),
                                       prior_intercept = rstanarm::cauchy(0, 5))
```

```{r}
load("ignore/model_rstanarm.rda")
```

```{r}
model_rstanarm %>%
  as.data.frame() %>%
  as_tibble() %>%
  ggplot(aes(x = corResp)) +
  geom_histogram()
```

