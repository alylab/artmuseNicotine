---
title: "multilevel smokers art gallery analyses"
author: "Monica Thieu"
date: "1/22/2020"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(magrittr)
require(rlang)
options(mc.cores = parallel::detectCores())

snodgrass <- function (num, denom) return((num+.5)/(denom+1))
snodgrass_vec <- function (vec) return((sum(vec) + 0.5) / (length(vec) + 1))
sdt_pr <- function (hit, fa) return(hit - fa)
sdt_br <- function(hit, fa) return(fa / (1 - (hit - fa)))
sdt_aprime <- function (hit, fa) return(.5 + (sign(hit-fa)*((hit-fa)^2 + abs(hit-fa))/(4*pmax(hit,fa)-(4*hit*fa))))
sdt_b2prime <- function (hit, fa)  return(sign(hit-fa)*(hit*(1-hit) - fa*(1-fa))/(hit*(1-hit) + fa*(1-fa)))
sdt_dprime <- function (hit, fa) return(qnorm(hit) - qnorm(fa))
sdt_c <- function (hit, fa) return(-.5 * (qnorm(hit) + qnorm(fa)))

posterior_preplot_params <- function (object) {
  out <- object %>%
    as.data.frame() %>%
    as_tibble() %>%
    mutate(iteration = 1:nrow(.)) %>%
    # removes all random effects and sigma terms. should yield fixed effects only
    select(-contains("["), -contains("sigma")) %>%
    rename(intercept = "(Intercept)") %>%
    pivot_longer(cols = -iteration, names_to = "term", values_to = "estimate")
  
  return (out)
}

posterior_preplot_bysubj <- function (object, newdata, pred_col = "y_pred", draws = 1000) {
  out <- object %>%
    rstanarm::posterior_linpred(transform = TRUE,
                                newdata = newdata,
                                re.form = NULL,
                                draws = draws)

  # Just the median of every predicted point for every subject
  # Note that this doesn't select in a paired way for the "median iteration"
  # returns a VECTOR which needs to get slapped onto newdata
  out %<>%
    apply(2, median) %>%
    t() %>%
    c()
  
  newdata %<>%
    mutate(!!pred_col := out)
  
  return (newdata)
}

posterior_preplot_fixef <- function (object, newdata, pred_col = "y_pred", draws = 1000) {
  
  out <- object %>%
    rstanarm::posterior_linpred(transform = TRUE,
                                newdata = newdata,
                                re.form = NA,
                                draws = draws)
  
  newdata %<>%
    # Must expand AFTER predictions is already done to repeat for iterations
    # need the "obs" column to make damn sure that the correct predicted points get pasted on the correct x values
    mutate(obs = 1:nrow(.),
           iteration = map(obs, ~1:draws)) %>%
    unchop(iteration)
  
  out %<>%
    as_tibble() %>%
    mutate(iteration = 1:nrow(.)) %>%
    pivot_longer(cols = -iteration, names_to = "obs", values_to = pred_col) %>%
    mutate(obs = as.integer(obs)) %>%
    right_join(newdata, by = c("obs", "iteration")) %>%
    # the obs column obstructs any later pivoting, and is technically redundant if all the x cols are in there,
    # so get outta here
    select(-obs)
  
  return(out)
}

demos = read_csv("ignore/demographics/demo_smoke_habits.csv") %>%
  mutate(cigs_per_day_est = 10 * cigs_per_day_est) %>%
  mutate_if(is.numeric, as.integer) %>%
  mutate(cigs_per_day_est = .1 * cigs_per_day_est,
         ppm_on = if_else(condition == 1, ppm_s1, ppm_s2),
         ppm_off = if_else(condition == 1, ppm_s2, ppm_s1))

raw = tibble(filename = list.files("ignore/data_raw", pattern = ".txt", full.names = TRUE)) %>%
  mutate(data = map(filename, ~.x %>%
                      read_delim(delim = "\t",
                                 skip = 9,
                                 col_names = FALSE) %>%
                      select(trial = X1,
                             stimOnsetTime = X2,
                             exptCond = X4,
                             stimNum = X6,
                             cue = X7,
                             probe = X8,
                             valid = X9,
                             resp = X10,
                             corResp = X11,
                             acc = X12,
                             rt = X13) %>%
                      mutate_at(c("trial", "exptCond", "valid", "resp", "corResp", "acc"),
                                as.integer) %>%
                    mutate_at(c("cue", "probe"), ~recode(., `1` = "art", `2` = "room")))) %>%
  mutate(subj_num = as.integer(str_sub(filename, start = 32L, end = 34L)),
         session_num = str_sub(filename, start = -5L, end = -5L),
         session_num = if_else(session_num == "2", 2L, 1L)) %>%
  select(-filename) %>%
  left_join(demos %>%
              select(subj_num, condition, ppm_on, ppm_off) %>%
              pivot_longer(names_to = "on_smoking", values_to = "ppm", cols = starts_with("ppm")) %>% 
              mutate(on_smoking = recode(on_smoking, ppm_on = 1L, ppm_off = 0L),
                     ppm_z = c(scale(ppm))),
            by = "subj_num") %>%
  # Scrub all subjects who don't appear in demographics data
  filter(!is.na(condition)) %>%
  mutate(on_smoking = as.integer(session_num == condition)) %>%
  unnest(data)
```

## checking data quality

```{r}
# Should be 0 length
raw %>%
  count(subj_num, on_smoking) %>%
  filter(n < 80)
```

For eyeballing:

```{r}
raw %>%
  group_by(subj_num, on_smoking, corResp) %>%
  summarize(mean_acc = mean(acc)) %>%
  pivot_wider(names_from = corResp, values_from = mean_acc, names_prefix = "rate_") %>%
  rename(rate_cr = rate_0, rate_hit = rate_1) %>%
  mutate(rate_fa = 1 - rate_cr) %>%
  ggplot(aes(x = rate_hit, y = rate_fa, color = factor(on_smoking))) +
  geom_point()
```

## Purely descriptive statistix

Pretty sure most of these hinge on manually calculating A'/d' and such.

### Manually calculating SDT metrics: Craazy right?

```{r}
sdt_metrics <- raw %>%
  filter(valid == 1) %>%
  mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
         on_smoking = recode(on_smoking, `0` = "off", `1` = "on"),
         exptCond = recode(exptCond, `0` = "control", `1` = "relational")) %>%
  group_by(subj_num, on_smoking, exptCond, cue, corResp) %>%
  summarize(rate = mean(resp), snod = snodgrass_vec(resp), n_trials = n()) %>%
  pivot_wider(names_from = corResp, values_from = c(rate, snod)) %>%
  mutate(aprime = sdt_aprime(rate_hit, rate_fa),
         aprime_snod = sdt_aprime(snod_hit, snod_fa),
         dprime = sdt_dprime(snod_hit, snod_fa),
         pr = sdt_pr(rate_hit, rate_fa))
```

```{r}
sdt_metrics %>%
  ggplot(aes(x = aprime, y = aprime_snod)) +
  geom_abline(slope = 1, intercept = 0, linetype = 3) +
  geom_point(alpha = 0.5)
```

```{r}
sdt_metrics %>%
  ggplot(aes(x = aprime, y = dprime)) +
  geom_point(alpha = 0.5)
```

```{r}
sdt_metrics %>%
  ggplot(aes(x = aprime_snod, y = dprime)) +
  geom_point(alpha = 0.5)
```

Doing the `qnorm()` transform as d' does introduces nonlinearity into the SDT metrics, predictably. But they are still basically Spearman rho >= 0.97.

```{r}
sdt_metrics %>%
  ggplot(aes(x = exptCond, y = aprime, color = cue)) +
  geom_line(aes(group =interaction(subj_num, cue)), alpha = 0.5) +
  geom_point() +
  facet_grid(~ on_smoking)
```

Attempting to recreate the original "significant" statistic from Nick's descriptive analysis

```{r}
sdt_metrics %>%
  ungroup() %>%
  select(subj_num:cue, aprime) %>%
  ggplot(aes(x = on_smoking, y = aprime)) +
  geom_line(aes(group = subj_num), alpha = 0.2) +
  geom_line(aes(group = 1),
            data = sdt_metrics %>%
              ungroup() %>%
              select(subj_num:cue, aprime) %>%
              group_by(on_smoking, cue, exptCond) %>%
              summarize(aprime = median(aprime)),
            size = 1) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = 3) +
  facet_grid(~ exptCond + cue)
```

```{r}
sdt_metrics %>%
  ungroup() %>%
  mutate(on_smoking = fct_rev(on_smoking)) %>%
  select(subj_num:cue, rate_hit, rate_fa) %>%
  pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
  ggplot(aes(x = on_smoking, y = rate)) +
  geom_line(aes(group = subj_num), alpha = 0.2) +
  geom_line(aes(group = 1),
            data = sdt_metrics %>%
              ungroup() %>%
              select(subj_num:cue, rate_hit, rate_fa) %>%
              pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
              group_by(on_smoking, cue, exptCond, rate_type) %>%
              summarize(rate = mean(rate)),
            size = 1) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = 3) +
  facet_grid(rate_type ~ exptCond + cue)
```


## model fittin

As of 02/05/2020: Keep the original "onoff" model, and add one where the two-way interactions with `corResp` are allowed to vary by subject as well, then do all the model diagnosis stuff per usual

```{r, eval = FALSE}
models <- tibble(name = c("full", "full_random", "control", "relational"),
                 has_exptCond = list(0:1, 0:1, 0L, 1L)) %>%
  mutate(data = map(has_exptCond, ~raw %>%
                      filter(valid == 1, exptCond %in% .x)),
         terms = map(1:n(), ~c("corResp", "probe", "on_smoking")),
         terms = map_if(terms, lengths(has_exptCond) > 1,
                        ~c(.x, "exptCond"),
                        .else = ~.x),
         ranefs = if_else(name == "full_random",
                          "(1 + (corResp + probe + exptCond + on_smoking)^2 | subj_num)",
                          "(1 + corResp | subj_num)"),
         txt_formula = map_chr(terms, ~paste(.x, collapse = " + ")),
         txt_formula = paste0("resp ~ (", txt_formula, ")^3 + ", ranefs),
         model = map2(txt_formula, data, ~rstanarm::stan_glmer(as.formula(.x),
                                                               family = binomial(link = "logit"),
                                                               data = .y,
                                                               prior = rstanarm::cauchy(0, 5),
                                                               prior_intercept = rstanarm::cauchy(0, 5))))

save(models, file = "ignore/data_R/models_rstanarm.rda")
```

```{r}
load("ignore/data_R/models_rstanarm.rda")
```

## results preppin

```{r, eval = FALSE}
preplots_params <- models %>%
  select(name, iterations = model) %>%
  mutate(iterations = map(iterations, ~posterior_preplot_params(.x)))

preplots_bysubj <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select("subj_num", .y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_bysubj(.x, .y, pred_col = "resp_pred")),
         predicted = map(predicted, ~.x %>%
                           mutate_at(vars(one_of("exptCond")), ~recode(.x, `0` = "control", `1` = "relational")) %>%
                           mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
                                  on_smoking = recode(on_smoking, `0` = "off", `1` = "on")) %>%
                           pivot_wider(names_from = corResp,
                                       values_from = resp_pred,
                                       names_prefix = "rate_") %>%
                           mutate(aprime = sdt_aprime(rate_hit, rate_fa),
                                  dprime = sdt_dprime(rate_hit, rate_fa)))) %>%
  select(name, predicted)

preplots_fixef <- models %>%
  select(name, terms, data, model) %>%
  mutate(data = map2(data, terms, ~.x %>% select(.y) %>% distinct()),
         predicted = map2(model, data, ~posterior_preplot_fixef(.x, .y, pred_col = "resp_pred")),
         predicted = map(predicted, ~.x %>%
                           mutate_at(vars(one_of("exptCond")), ~recode(.x, `0` = "control", `1` = "relational")) %>%
                           mutate(corResp = recode(corResp, `0` = "fa", `1` = "hit"),
                                  on_smoking = recode(on_smoking, `0` = "off", `1` = "on")) %>%
                           pivot_wider(names_from = corResp,
                                       values_from = resp_pred,
                                       names_prefix = "rate_") %>%
                           mutate(aprime = sdt_aprime(rate_hit, rate_fa),
                                  dprime = sdt_dprime(rate_hit, rate_fa)))) %>%
  select(name, predicted)

save(preplots_params, preplots_bysubj, preplots_fixef, file = "ignore/data_R/preplots_rstanarm.rda")
```

```{r}
load("ignore/data_R/preplots_rstanarm.rda")
```

```{r}
preplots_raw_bysubj <- bind_rows(model_sparse = preplots_bysubj$predicted[[1]],
                           model_random = preplots_bysubj$predicted[[2]],
                           raw = sdt_metrics %>%
                             select(subj_num, on_smoking, exptCond, probe = cue, rate_fa, rate_hit, aprime, dprime),
                           .id = "name")

preplots_raw_fixef <- preplots_fixef$predicted[[2]] %>%
  arrange(iteration, probe, exptCond, on_smoking) %>%
  group_by(iteration, probe, exptCond) %>%
  summarize(diff_rate_fa = diff(rate_fa),
            diff_rate_hit = diff(rate_hit),
            diff_aprime = diff(aprime)) %>%
  pivot_longer(starts_with("diff"), names_to = "metric_type", values_to = "diff_smoking", names_prefix = "diff_") %>%
  nest(diffs = -c(probe, exptCond, metric_type)) %>%
  mutate(diff_smoking_q025 = map_dbl(diffs, ~quantile(.x$diff_smoking, .025)),
         diff_smoking_q50 = map_dbl(diffs, ~median(.x$diff_smoking)),
         diff_smoking_q975 = map_dbl(diffs, ~quantile(.x$diff_smoking, .975))) %>%
  left_join(sdt_metrics %>%
              rename(probe = cue) %>%
              arrange(subj_num, probe, exptCond, on_smoking) %>%
              group_by(subj_num, probe, exptCond) %>%
              summarize(diff_rate_fa = diff(rate_fa),
                        diff_rate_hit = diff(rate_hit),
                        diff_aprime = diff(aprime)) %>%
              ungroup() %>%
              pivot_longer(starts_with("diff"), names_to = "metric_type", values_to = "diff_smoking", names_prefix = "diff_") %>%
              group_by(probe, exptCond, metric_type) %>%
              summarize(raw_median_diff_smoking = median(diff_smoking),
                        raw_mean_diff_smoking = mean(diff_smoking)),
            by = c("probe", "exptCond", "metric_type"))
```


## results graphin

### parameter estimates

Parameter estimates from model 1 and model 2, where both control and relational trials are included and `exptCond` is used as a predictor to look at interactions of d' and all conditions. Model 1 fixes all interaction effects, and only has a random effect of intercept and `corResp` (overall d'), while model 2 allows all second-order interactions to vary by subject as well.

```{r}
preplots_params %>%
  filter(startsWith(name, "full")) %>%
  unnest(iterations) %>%
  ggplot(aes(x = estimate)) +
  geom_histogram(aes(fill = name), position = "identity", alpha = 0.4) +
  geom_vline(xintercept = 0, linetype = 3) +
  geom_vline(aes(xintercept = estimate, color = name),
             data = preplots_params %>%
               filter(startsWith(name, "full")) %>%
               unnest(iterations) %>%
               group_by(name, term) %>%
               summarize(estimate = median(estimate)),
             linetype = 3) +
  facet_wrap(~ term, scales = "free")
```

Based on at least the parameter estimates of the fixed effects, it looks like the model with the random effects isn't drastically different in median estimates of most of the fixed effects. Sure the standard errors are bigger, but I think I'm ok with this. As you'll see below, allowing more random effects reduces the effective regularization of single subject d', leaving more variability in place. I think we want this!

### Plotting predicted d' and stuff

#### Explicitly comparing the raw to the models

Plotting the condition-wise A' estimated from subjects' raw hit and FA rates as well as their model-estimated hit and FA rates. Here you can see much more clearly that both models (few random effects and all second-order random effects) serve to regularize condition-wise A' values that differ very much from that subject's other condition-wise A' values. The sparser model is regularizing much more heavily than the fuller model with second-order random effects.

```{r}
preplots_raw_bysubj %>%
  ggplot(aes(x = interaction(on_smoking, probe, exptCond), y = aprime, color = name)) +
  geom_line(aes(group = name)) +
  geom_point(size = 0.5) +
  labs(x = "every sub-condition",
       y = "A'",
       title = "Raw and model-estimated A' by condition by subject",
       subtitle = "The models regularize, adding random effects regularizes less") +
  facet_wrap(~subj_num) +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```

In general, I'm not too worried about discrepancies between the model-fit data and the raw data, because this shows that the random-effects model is doing a pretty good job of retaining condition-level performance that's lower, but regularizing it up a bit higher.

#### Reproducing Nick's plots (ish), with model on top

You'll go on to see that the predicted effects map well on to raw-derived _mean_ values for A', hit rate, and false alarm rate. When the plots are rendered with raw-derived _median_ values, the between-condition slopes are a little steeper, but maybe not in an interesting way.

```{r}
preplots_raw_bysubj %>%
  filter(name != "model_sparse") %>%
  mutate(on_smoking = fct_rev(on_smoking)) %>%
  ggplot(aes(x = on_smoking, y = aprime, color = name)) +
  geom_line(aes(group = interaction(subj_num, name)), alpha = 0.15) +
  geom_jitter(width = 0.1, alpha = 0.4) +
  geom_line(aes(group = name),
            data = preplots_raw_bysubj %>%
              filter(name != "model_sparse") %>%
              mutate(on_smoking = fct_rev(on_smoking)) %>%
              group_by(name, on_smoking, exptCond, probe) %>%
              summarize(aprime = median(aprime)),
            size = 2) +
  geom_hline(yintercept = 0.5, linetype = 3) +
  labs(title = "cholinergic modulation of A' by all the conditions") +
  facet_grid( ~ exptCond + probe)
```

```{r}
preplots_raw_bysubj %>%
  filter(name != "model_sparse") %>%
  select(-aprime, -dprime) %>%
  pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
  mutate(on_smoking = fct_rev(on_smoking),
         rate_type = fct_rev(rate_type)) %>%
  ggplot(aes(x = on_smoking, y = rate, color = name)) +
  geom_line(aes(group = interaction(subj_num, name)), alpha = 0.1) +
  geom_line(aes(group = name),
            data = preplots_raw_bysubj %>%
              filter(name != "model_sparse") %>%
              select(-aprime, -dprime) %>%
              pivot_longer(starts_with("rate"), names_to = "rate_type", values_to = "rate") %>%
              mutate(on_smoking = fct_rev(on_smoking),
                     rate_type = fct_rev(rate_type)) %>%
              group_by(name, on_smoking, probe, exptCond, rate_type) %>%
              summarize(rate = mean(rate)),
            size = 1) +
  geom_jitter(width = 0.1, alpha = 0.5) +
  labs(title = "cholinergic modulation of hit/FA rate by all the conditions") +
  facet_grid(rate_type ~ exptCond + probe)
```

#### fixed effects over everyone

The most important thing to do here will be to generate posterior distributions of test statistics of interest, now that all the overall effect visualization can be done on the by-subject predictions.

As far as I understand it, the key test statistics all depend on _the difference between the on-smoking and off-smoking conditions._

Accordingly, the preplot object being used here has `diff_smoking` calculated over iterations as a default.

```{r}
preplots_raw_fixef %>%
  unnest(diffs) %>%
  ggplot(aes(x = diff_smoking, fill = probe)) +
  geom_density(position = "identity", alpha = 0.5) +
  geom_vline(aes(xintercept = raw_mean_diff_smoking, color = probe),
             data = preplots_raw_fixef,
             linetype = 2) +
  geom_vline(xintercept = 0, linetype = 3) +
  facet_grid(metric_type ~ exptCond, scales = "free_x")
```

```{r}
preplots_raw_fixef %>%
  mutate(metric_type = recode(metric_type,
                              aprime = "A'",
                              rate_fa = "false alarm rate",
                              rate_hit = "hit rate")) %>%
  select(-starts_with("diff_")) %>%
  unnest(diffs) %>%
  ggplot(aes(x = exptCond, y = diff_smoking, fill = probe, color = probe)) +
  geom_hline(yintercept = 0, linetype = 3) +
  geom_violin(position = "identity", draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.2) +
  geom_point(aes(y = raw_median_diff_smoking),
             data = preplots_raw_fixef %>%
                 mutate(metric_type = recode(metric_type,
                              aprime = "A'",
                              rate_fa = "false alarm rate",
                              rate_hit = "hit rate")),
             size = 3) +
  labs(x = "control or relational?",
       y = "ON - OFF smoking difference",
       title = "on-off smoking diffs by condition",
       subtitle = "Big dots: across-subject MEANS from raw data") +
  facet_grid(~ metric_type)
```

### plotting test statistics

02/14/2020: Plot the betas concerning `corResp` in A'/hit/FA rate space for all of the relevant interactions to characterize what they mean. Or something.

```{r}
preplots_fixef$predicted[[2]] %>%
  ggplot(aes(x = interaction(on_smoking, probe), y = aprime, color = exptCond)) +
  geom_line(aes(group = interaction(iteration, exptCond)), alpha = 0.01) +
  geom_line(aes(group = exptCond),
            data = preplots_fixef$predicted[[2]] %>%
              group_by(on_smoking, probe, exptCond) %>%
              summarize(aprime = median(aprime)))
```


Searching for the following difference from the descriptive-only statistics:

relational trials: FA_on < FA_off for room, FA_on == FA_off for art

control trials: no such differences?

```{r}
preplots_raw_fixef %>%
  select(probe, exptCond, metric_type, diffs) %>%
  unnest(diffs) %>%
  arrange(metric_type, iteration, exptCond, probe) %>%
  group_by(metric_type, iteration, exptCond) %>%
  summarize(diff_smoking_probe = diff(diff_smoking)) %>%
  ungroup() %>%
  nest(data = -iteration) %>%
  sample_n(400) %>%
  unnest(data) %>%
  ggplot(aes(x = exptCond, y = diff_smoking_probe)) +
  geom_line(aes(group = iteration), alpha = 0.05) +
  # geom_violin(position = "identity", draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = 3) +
  labs(title = "Is the on - off difference bigger in room than art condition?") +
  facet_grid(~ metric_type, scales = "free_x")
```

```{r}
preplots_raw_fixef %>%
  select(probe, exptCond, metric_type, diffs) %>%
  unnest(diffs) %>%
  arrange(metric_type, iteration, probe, exptCond) %>%
  group_by(metric_type, iteration, probe) %>%
  summarize(diff_smoking_exptCond = diff(diff_smoking)) %>%
  ggplot(aes(x = diff_smoking_exptCond, fill = probe)) +
  geom_density(position = "identity", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = 3) +
  facet_grid(~ metric_type, scales = "free_x")
```


### Doing significance tests on model predicted data

02/14/2020: Run Matlab-style `signtest()` on the on-off difference data to recreate Nick's original result

## a simulation analysis?

